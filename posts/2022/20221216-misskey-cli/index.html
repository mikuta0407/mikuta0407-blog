<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="この記事はMisskey Advent Calendar 2022 16日目の記事です。 こんにちは。たっくん(@mikuta0407)です。 GoでMisskeyのCLIクライアン"><title>GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)</title>
<link rel=canonical href=https://blog.mikuta0407.net/posts/2022/20221216-misskey-cli/><link rel=stylesheet href=/scss/style.min.01b3ec666d6f6bb6342716ec85d85dcf1a50190d2a63506d495d154e2fd852b8.css><meta property='og:title' content="GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)"><meta property='og:description' content="この記事はMisskey Advent Calendar 2022 16日目の記事です。 こんにちは。たっくん(@mikuta0407)です。 GoでMisskeyのCLIクライアン"><meta property='og:url' content='https://blog.mikuta0407.net/posts/2022/20221216-misskey-cli/'><meta property='og:site_name' content='平和に生きたい'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2022-12-16T00:00:00+09:00'><meta property='article:modified_time' content='2022-12-16T00:00:00+09:00'><meta property='og:image' content='https://blog.mikuta0407.net/posts/2022/20221216-misskey-cli/img/misskey-cli-scr.png'><meta name=twitter:title content="GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)"><meta name=twitter:description content="この記事はMisskey Advent Calendar 2022 16日目の記事です。 こんにちは。たっくん(@mikuta0407)です。 GoでMisskeyのCLIクライアン"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://blog.mikuta0407.net/posts/2022/20221216-misskey-cli/img/misskey-cli-scr.png'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/mikuta0407-icon_hua8f22b6667bbcefae8d1b7d0dca296d9_162513_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>平和に生きたい</a></h1><h2 class=site-description>mikuta0407の書いた虚無。ﾖﾜﾖﾜ技術系からアイマスとかガジェットとかごった煮。</h2></div></header><ol class=menu-social><li><a href=https://github.com/mikuta0407 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/mikuta0407 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#動機>動機</a></li><li><a href=#使ったもの>使ったもの</a></li><li><a href=#各実装部分>各実装部分</a><ol><li><a href=#cobra>cobra</a></li><li><a href=#コンフィグ周り>コンフィグ周り</a></li><li><a href=#apiのpost>APIのPOST</a></li><li><a href=#投稿リプライリノート削除>投稿・リプライ・リノート・削除</a><ol><li><a href=#投稿>投稿</a></li><li><a href=#リプライ>リプライ</a></li><li><a href=#リノート>リノート</a></li><li><a href=#削除>削除</a></li></ol></li><li><a href=#tl取得>TL取得</a></li><li><a href=#通常投稿>通常投稿</a><ol><li><a href=#リプライ-1>リプライ</a></li><li><a href=#リノート-1>リノート</a></li></ol></li><li><a href=#その他表示に関わる部分いつかなにか改善したら追記>その他表示に関わる部分(いつかなにか改善したら追記)</a><ol><li><a href=#1行の文字数>1行の文字数</a></li></ol></li></ol></li><li><a href=#まとめ>まとめ</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/2022/20221216-misskey-cli/><img src=/posts/2022/20221216-misskey-cli/img/misskey-cli-scr_hu951e91d74c3322dab0f9ffb021ed0c8b_6422243_800x0_resize_box_3.png srcset="/posts/2022/20221216-misskey-cli/img/misskey-cli-scr_hu951e91d74c3322dab0f9ffb021ed0c8b_6422243_800x0_resize_box_3.png 800w, /posts/2022/20221216-misskey-cli/img/misskey-cli-scr_hu951e91d74c3322dab0f9ffb021ed0c8b_6422243_1600x0_resize_box_3.png 1600w" width=800 height=510 loading=lazy alt="Featured image of post GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)"></a></div><div class=article-details><header class=article-category><a href=/categories/linux/>Linux
</a><a href=/categories/go/>Go
</a><a href=/categories/misskey/>Misskey
</a><a href=/categories/%E7%9B%86%E6%A0%BD%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E9%96%8B%E7%99%BA/>盆栽システム開発</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2022/20221216-misskey-cli/>GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2022-12-16</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 16分</time></div></footer></div></header><section class=article-content><p>この記事は<a class=link href=https://adventar.org/calendars/7354 target=_blank rel=noopener>Misskey Advent Calendar 2022</a> 16日目の記事です。</p><p>こんにちは。たっくん(@mikuta0407)です。</p><p>GoでMisskeyのCLIクライアントを作ったので、宣伝も兼ねてアドカレに参加してみようと思います。よろしくお願いします。</p><hr><p>早速ですが、こんな感じのCLIなMisskeyクライアントを作りました。</p><p><img src=/posts/2022/20221216-misskey-cli/img/194720200-8dbf0394-9d4b-4e84-ad91-739eb0fec1c4.png width=3886 height=2475 srcset="/posts/2022/20221216-misskey-cli/img/194720200-8dbf0394-9d4b-4e84-ad91-739eb0fec1c4_hu951e91d74c3322dab0f9ffb021ed0c8b_6422243_480x0_resize_box_3.png 480w, /posts/2022/20221216-misskey-cli/img/194720200-8dbf0394-9d4b-4e84-ad91-739eb0fec1c4_hu951e91d74c3322dab0f9ffb021ed0c8b_6422243_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=157 data-flex-basis=376px></p><p><a class=link href=https://github.com/mikuta0407/misskey-cli target=_blank rel=noopener><img src=https://gh-card.dev/repos/mikuta0407/misskey-cli.svg loading=lazy alt=mikuta0407/misskey-cli></a></p><p><a class=link href=https://github.com/mikuta0407/misskey-cli target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli</a></p><p>ここで配布してます。</p><p>もし良ければ是非。Linux(amd64/aarch32/aarch64)/macOS(M1)で動作を確認しています。</p><p>MITライセンスではありますが、割と適当にお使いください。(使用ライブラリ的にMITライセンスが楽だなとなった感じです)</p><p>使い方はGitHubのREADMEにあるのである程度割愛するとして、この記事では実装方法について振り返りも兼ねて紹介しようと思います。</p><p>ちなみに、書いている最中に引用リノートの投稿/表示に対応していないことに気づきましたが、修正する時間がなかったので今後追加予定の機能ということにして……そのまま行きます。</p><h2 id=動機>動機</h2><p>mattnさんの<code>twty</code> (<a class=link href=https://github.com/mattn/twty target=_blank rel=noopener>https://github.com/mattn/twty</a>) が作業中TwitterのカモフラージュにCLIでTwitterするのに便利だったので、Misskey版っぽいのも作りたいなぁと思い、やってみました。</p><p>あと、ついでにGoを大真面目に学んでいるところでもあったので、アウトプットという意味でも何か形にしたかったので、「せっかくtwtyがGoなら、Goで作ってシングルバイナリかつマルチプラットフォームやるぞ」という気持ちもありました。</p><h2 id=使ったもの>使ったもの</h2><ul><li>Go言語 (1.19)<ul><li>標準以外のパッケージ<ul><li>github.com/BurntSushi/toml</li><li>github.com/buger/jsonparser</li><li>github.com/spf13/cobra</li><li>golang.org/x/crypto</li></ul></li></ul></li><li>Misskey API<ul><li><a class=link href=https://misskey-hub.net/docs/api/ target=_blank rel=noopener>https://misskey-hub.net/docs/api/</a></li></ul></li></ul><h2 id=各実装部分>各実装部分</h2><p>ここからは、どんな感じで実装していったのかについて、振り返っていきます。</p><h3 id=cobra>cobra</h3><p>サブコマンドを実装するため、cobraを採用し、<code>tl``note``renote</code> の3つのサブコマンドを実装しました。</p><p>このサブコマンドの中で更にフラグを使ってモードを分けています。実際に階層を表すと(ただのヘルプの日本語訳になりそうですが)、</p><ul><li><code>tl</code>: TL表示<ul><li><code>-l</code>: 一度に表示する件数</li><li><code>-m</code>: TLのモード(ホーム/ローカル/グローバル)</li></ul></li><li><code>note</code>: 投稿系<ul><li><code>-d</code>: 投稿削除</li><li><code>-r</code>: リプライ</li><li>なし: 通常投稿</li></ul></li><li><code>renote</code>: リノート<ul><li>引用RTには現状対応していません。(簡単にできるんだけどコマンド体系で悩み中)</li></ul></li><li>共通フラグ<ul><li><code>-c</code>: コンフィグファイルのパス指定(オプション)</li><li><code>-t</code>: インスタンス切り替え指定 こんな感じになります。</li></ul></li></ul><p>また、表示件数とTLのモードとコンフィグファイルのパスは指定されなかった場合のデフォルト値を指定している他、インスタンス切り替えに関しては(後述しますが)指定されなかった場合はコンフィグファイルの一番上のインスタンスを使うようにしています。</p><p>cobra自体の説明はここでしてもあまり意味がないため、これくらいにさせてください。</p><h3 id=コンフィグ周り>コンフィグ周り</h3><p>インスタンスの接続情報を持つコンフィグファイルはtoml形式で記述します。</p><p>(この記事を執筆している段階では、プログラム側からコンフィグファイルを生成する機能は無いので、手動で記述する必要があります。)</p><p>例:</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[[</span><span class=nx>Instance</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>  <span class=nx>host</span> <span class=p>=</span> <span class=nx>https</span><span class=err>://</span><span class=nx>misskey</span><span class=p>.</span><span class=nx>io</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=p>=</span> <span class=nx>misskey</span><span class=p>.</span><span class=nx>io</span>
</span></span><span class=line><span class=cl>  <span class=nx>token</span> <span class=p>=</span> <span class=nx>hOgEFuGA</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span> <span class=p>=</span> <span class=nx>mikuta0407</span></span></span></code></pre></td></tr></table></div></div></div></div><p>tomlのパースは<code>github.com/BurntSushi/toml</code>で行っています。</p><p>インスタンスの接続情報はtoml内に複数記述できるようにしているので、構造体の宣言はインスタンス情報が入った構造体(<code>InstanceInfo</code>)の配列(<code>Instance</code>)、というようにしています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Instance</span> <span class=p>[]</span><span class=nx>InstanceInfo</span> <span class=s>`toml:Instance`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>InstanceInfo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Host</span>     <span class=kt>string</span> <span class=s>`toml:host validate:required`</span> <span class=c1>// 接続先ホスト
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Name</span>     <span class=kt>string</span> <span class=s>`toml:name validate:required`</span> <span class=c1>// フレンドリ名(-iオプションで指定する文字列)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Token</span>    <span class=kt>string</span> <span class=s>`toml:token validate:required`</span> <span class=c1>// Misskeyのアクセストークン
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserName</span> <span class=kt>string</span> <span class=s>`toml:username validate:required`</span> <span class=c1>// コンソールに表示するユーザー名(本来はなくてもいいがtoml内の識別用に一応
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>そして、<code>toml.DecodeFile</code>でtomlファイルの内容を構造体配列に入れています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ParseToml</span><span class=p>(</span><span class=nx>fileName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>Config</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>configs</span> <span class=nx>Config</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>toml</span><span class=p>.</span><span class=nf>DecodeFile</span><span class=p>(</span><span class=nx>fileName</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>configs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>configs</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>この後は、例えば2つめのインスタンス情報のトークンが欲しければ、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>config.Instance[1].Token</span></span></code></pre></td></tr></table></div></div></div></div><p>のように書くことで取得できるようになります。</p><p>ちなみに、<code>-i</code>オプションでインスタンスを指定しなかった場合の挙動ですが、自動で<code>[0]</code>の内容を使うようにしています。</p><p>また、インスタンス指定があった場合は</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>index</span><span class=p>,</span> <span class=nx>isExist</span> <span class=o>:=</span> <span class=nf>include</span><span class=p>(</span><span class=nx>configs</span><span class=p>.</span><span class=nx>Instance</span><span class=p>,</span> <span class=nx>instanceName</span><span class=p>)</span> <span class=c1>// 第1引数で渡したInstanceInfo配列から第2引数のインスタンス名が含まれている添え字を返す
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>instanceInfo</span> <span class=p>=</span> <span class=nx>configs</span><span class=p>.</span><span class=nx>Instance</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span></span></span></code></pre></td></tr></table></div></div></div></div><p>といったコードで、「指定されたインスタンスのフレンドリ名が含まれている添字を取得し、そこの内容を見に行く」という処理をしています。(実際は指定されたものが無かったときのエラーハンドリングもしています)</p><p>このコンフィグファイル周りの処理は、<code>misskey</code>パッケージのNewClientでクライアントインスタンス(言葉が厄介になってきた)を作成するときにtomlのパースを呼び出しつつ、インスタンス情報を確定した単一の<code>InstanceInfo</code>構造体を含むCleiint構造体を返すことで行っています。</p><p>…日本語で書くとむしろわかりにくいですね。</p><p>興味がある方は <a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/misskey.go#L18-L48 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/misskey.go#L18-L48</a> を見ていただけるとわかるかと思います。</p><h3 id=apiのpost>APIのPOST</h3><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/apipost.go#L11-L36 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/apipost.go#L11-L36</a></p><p>このコードの話です。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>apiPost</span><span class=p>(</span><span class=nx>jsonByte</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>endpoint</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>POST</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nx>InstanceInfo</span><span class=p>.</span><span class=nx>Host</span><span class=o>+/</span><span class=nx>api</span><span class=o>/+</span><span class=nx>endpoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nx>jsonByte</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>client</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Client</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=p>&lt;</span> <span class=mi>200</span> <span class=o>||</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=p>&gt;</span> <span class=mi>300</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>MisskeyのAPIはPOSTにJSONのリクエストボディをくっつけてHTTPのリクエストを送ることでレスポンスをもらえます。</p><blockquote><p>HTTP APIはすべてPOSTで、リクエスト/レスポンスともにJSON形式です。</p></blockquote><p><a class=link href=https://misskey-hub.net/docs/api/ target=_blank rel=noopener>https://misskey-hub.net/docs/api/</a></p><p>misskeyパッケージの<code>Client</code>の<code>apiPost</code>というメソッドで、引数に渡されたJSON文字列とエンドポイント先(API名?)を使ってPOSTしています。</p><p>この<code>apiPost</code>というメソッドは、<code>net/http</code>パッケージの<code>http.NewRequest</code>を使ってPOSTし、ステータスコードが200であれば返却されたレスポンスボディを<code>Client</code>構造体内の<code>resBuf</code>(<code>*bytes.Buffer</code>)に入れています。(200以外はerrorを返すので受けた側でエラーハンドリング)</p><p>例えば新規投稿では、<code>apiPost</code>メソッドにアクセストークンと投稿文字をJSONに流し込んだ<code>jsonByte</code>(json文字バイト列)と、<code>notes/create</code>という投稿用エンドポイントを<code>c.apiPost(jsonByte, notes/create)</code>として渡すことで投稿が出来ます。渡されたエンドポイントの文字列は、最初のコンフィグファイルパースのときに<code>Client</code>内<code>InstanceInfo.Host</code>に入っているMisskeyのホスト先に「<code>/api/</code>」と渡されたエンドポイント名を結合することでリクエスト先を生成しています。</p><p>アクセストークンについては、リクエストボディのJSON内では<code>i</code>というパラメータに渡すことで利用ができます。</p><p>(ちなみに、現状misskey-cliはアクセストークンの取得手段を実装していないため、tomlに記載するアクセストークンはブラウザ版から手動で取得する必要があります)</p><p>APIのドキュメントを見ると本当に色々と機能があり、眺めてみると面白いのでオススメです。</p><h3 id=投稿リプライリノート削除>投稿・リプライ・リノート・削除</h3><h4 id=投稿>投稿</h4><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L10-L40 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L10-L40</a>この関数の話です。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Client</span><span class=p>)</span> <span class=nf>CreateNote</span><span class=p>(</span><span class=nx>text</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>body</span> <span class=o>:=</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>I</span>    <span class=kt>string</span> <span class=s>`json:i`</span>
</span></span><span class=line><span class=cl>        <span class=nx>Text</span> <span class=kt>string</span> <span class=s>`json:text`</span>
</span></span><span class=line><span class=cl>    <span class=p>}{</span>
</span></span><span class=line><span class=cl>        <span class=nx>I</span><span class=p>:</span>    <span class=nx>c</span><span class=p>.</span><span class=nx>InstanceInfo</span><span class=p>.</span><span class=nx>Token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Text</span><span class=p>:</span> <span class=nx>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>jsonByte</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>apiPost</span><span class=p>(</span><span class=nx>jsonByte</span><span class=p>,</span> <span class=nx>notes</span><span class=o>/</span><span class=nx>create</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>(),</span> <span class=nx>createdNote</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>(),</span> <span class=nx>createdNote</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>Create</span> <span class=nx>Note</span><span class=p>:</span> <span class=err>@</span> <span class=o>+</span> <span class=nx>c</span><span class=p>.</span><span class=nx>InstanceInfo</span><span class=p>.</span><span class=nx>UserName</span> <span class=o>+</span>  <span class=p>(</span> <span class=o>+</span> <span class=nx>c</span><span class=p>.</span><span class=nx>InstanceInfo</span><span class=p>.</span><span class=nx>Host</span> <span class=o>+</span> <span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>printLine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>str</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>Note</span> <span class=nx>Success</span><span class=p>!</span> <span class=nx>id</span> <span class=p>:</span> <span class=o>%</span><span class=nx>s</span><span class=err>\</span><span class=nx>n</span><span class=err>\</span><span class=o>%</span><span class=nx>s</span><span class=err>\</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>id</span><span class=p>),</span> <span class=nb>string</span><span class=p>(</span><span class=nx>text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Misskeyのノート投稿のAPI仕様は、</p><p><a class=link href=https://misskey-hub.net/docs/api/endpoints/notes/create.html target=_blank rel=noopener>https://misskey-hub.net/docs/api/endpoints/notes/create.html</a>にありますが、</p><p><code>&lt;host>/api/notes/create</code>宛に、トークンと投稿内容をリクエストボディに入れてPOSTすることで投稿ができます。</p><p>curlで投稿をしてみると、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -X POST -d &#39;{i:hogehugaToken, text:ねこはいます ねこでした。}&#39; https://misskey.io/api/notes/create</span></span></code></pre></td></tr></table></div></div></div></div><p>を実行すれば、</p><p><img src=/posts/2022/20221216-misskey-cli/img/zPc5DtG.png width=870 height=858 srcset="/posts/2022/20221216-misskey-cli/img/zPc5DtG_hufd45c83c60526d2ad294b771fd737848_96456_480x0_resize_box_3.png 480w, /posts/2022/20221216-misskey-cli/img/zPc5DtG_hufd45c83c60526d2ad294b771fd737848_96456_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=101 data-flex-basis=243px></p><p>このように投稿ができます。(投稿したらすぐにスタンプが付いた。これぞMisskey)</p><p>この新規投稿に関しては、Client構造体のメソッド<code>CreateNote</code>として実装しました。</p><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L10-L40 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L10-L40</a></p><p>引数に渡されたテキストをbody用構造体にトークンとともに入れてjson.Marshalで文字バイト列<code>jsonByte</code>を作成し、先述のapiPostに<code>jsonByte</code>とエンドポイント先を渡すことで、投稿をしています。</p><p>misskey-cliで投稿をすると、以下のように投稿IDと投稿内容が表示されるようになっています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./misskey-cli note -i io 眠すぎる
</span></span><span class=line><span class=cl>misskey-cli  Create Note: @mikuta0407 <span class=o>(</span>https://misskey.io<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>=====================================</span>
</span></span><span class=line><span class=cl>Note Success! id : 98jwnbd39s
</span></span><span class=line><span class=cl>眠すぎる</span></span></code></pre></td></tr></table></div></div></div></div><p>この部分は、POSTしたときに戻ってきたJSONから値を取り出しています。</p><p>戻ってくるJSONは以下のようになっています。(実装上はClient構造体内<code>resBuf</code>に入っています)</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>createdNote:</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>    <span class=err>id:</span> <span class=err>98jwi9p10i,</span>
</span></span><span class=line><span class=cl>    <span class=err>createdAt:</span> <span class=err>2022-12-09T09:59:52.981Z,</span>
</span></span><span class=line><span class=cl>    <span class=err>userId:</span> <span class=err>8rhxi7gw77,</span>
</span></span><span class=line><span class=cl>    <span class=err>user:</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>      <span class=err>id:</span> <span class=err>8rhxi7gw77,</span>
</span></span><span class=line><span class=cl>      <span class=err>name:</span> <span class=err>null,</span>
</span></span><span class=line><span class=cl>      <span class=err>username:</span> <span class=err>mikuta0407,</span>
</span></span><span class=line><span class=cl>      <span class=err>host:</span> <span class=err>null,</span>
</span></span><span class=line><span class=cl>      <span class=err>avatarUrl:</span> <span class=err>https:</span><span class=c1>//s3.arkjp.net/misskey/thumbnail-b13bb7e7-c86b-47f4-bed7-aee75c5febf6.webp,
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=err>avatarBlurhash:</span> <span class=err>yILWR+-U7fS$xGX9s900WB9cR-xskCWBAwR*</span><span class=p>}</span><span class=err>TsmWBnPOE~CRk-pxaIVaes.Ads:xZjbNaS#r@%gkCNFWBWXi</span><span class=p>{</span><span class=err>tQ=yjZI;R*xGt6WC,</span>
</span></span><span class=line><span class=cl>      <span class=err>avatarColor:</span> <span class=err>null,</span>
</span></span><span class=line><span class=cl>      <span class=err>emojis:</span> <span class=err>[],</span>
</span></span><span class=line><span class=cl>      <span class=err>onlineStatus:</span> <span class=err>active,</span>
</span></span><span class=line><span class=cl>      <span class=err>driveCapacityOverrideMb:</span> <span class=err>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>text:</span> <span class=err>ねこはいます</span> <span class=err>ねこでした,</span>
</span></span><span class=line><span class=cl>    <span class=err>cw:</span> <span class=kc>null</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>visibility:</span> <span class=err>public,</span>
</span></span><span class=line><span class=cl>    <span class=err>renoteCount:</span> <span class=mi>0</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>repliesCount:</span> <span class=mi>0</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>reactions:</span> <span class=p>{}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>emojis:</span> <span class=p>[]</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>fileIds:</span> <span class=p>[]</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>files:</span> <span class=p>[]</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>replyId:</span> <span class=kc>null</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=err>renoteId:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>この中で表示したい部分は<code>createNote</code>の中の<code>id</code>と、<code>createNote</code>の中の<code>text</code>の2つです。</p><p>Go言語で普通JSONのパースを行うときは、JSONの中身に対応した構造体を宣言してそこにパースしていきますが、Misskeyの返却APIはパラメータが多く、かつ場合によっては中身の構造が増える(特に投稿ではなくRenote/Replyで発生する)ため、PHPの<code>json.decode</code>のように動的にパースできないGo言語では実装が大変です。</p><p>そこで、JSONのバイト列からその場で欲しい値をキー名ベースで持ってきてくれる<code>github.com/buger/jsonparser</code>を使って値を取得することにしました。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>id</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>(),</span> <span class=nx>createdNote</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>text</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>resBuf</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>(),</span> <span class=nx>createdNote</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>これであれば構造体をわざわざ宣言する必要がないので、JSONの構造が変わったとしても対応が可能となります。</p><p>あとは<code>id</code>と<code>text</code>を<code>fmt.Sprintf</code>等で表示すればよいので、このライブラリには大変助けれられました。</p><h4 id=リプライ>リプライ</h4><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L42-L71 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L42-L71</a></p><p>ここの<code>ReplyNote</code>関数の話です(CreateNoteと重複する部分が多いためコード貼るのは省略)</p><p>リプライは投稿と同様に<code>notes/create</code>のAPIを使用します。</p><p>先程はリクエストボディ内はトークンと内容だけでしたが、リプライするには<code>replyId</code>を追加することでリプライが出来ます。</p><p>replyIdを追加することで、指定したノートのID(ノートのURL等で最後についている文字列。↑の投稿例だと<code>98jwnbd39s</code>がノートID)にリプライをする、指示しています。</p><p><code>-r</code>オプションでもらったreplyIdを追加して新規投稿と同様にPOSTしているだけなので、後の解説は割愛します。</p><h4 id=リノート>リノート</h4><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L73-L100 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L73-L100</a></p><p>ここの<code>RenoteNote</code>関数の話です。コード貼るのは省略。</p><p>リノートも投稿・リプライと同様に<code>notes/create</code>のAPIを使用します。</p><p>リプライの時の<code>replyId</code>の代わりに<code>renoteId</code>を付与してPOSTするだけでリノートが出来ます。</p><p>現状misskey-cliでは実装できていませんが、引用リノートがMisskeyには存在します。</p><p>引用リノートをする場合は、リプライとほぼ同じようにトークン・renoteId・テキストの3つをPOSTすることで引用リノートができます。</p><p>(余談) クライアントである以上はmisskey-cliでもちゃんと追加はしたいのですが、 <code>misskey-cli renote 98jwnbd39s</code>といったようにすることでリノートをするよう実装してしまったため、引用リノートをするときはどういうコマンド/オプション体系にすればいいかを悩んでしまっています。</p><h4 id=削除>削除</h4><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L102-L127 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/postnotes.go#L102-L127</a></p><p>ここの<code>DeleteNote</code>関数の話です。</p><p>削除はエンドポイントこそ<code>api/notes/delete</code>と投稿系と異なりますが、リクエストボディ自体はほぼリノートと同様で、トークンと削除したい<code>noteId</code>を指定してPOSTすることで削除が行なえます。</p><p>(これ以上書くことがない)</p><h3 id=tl取得>TL取得</h3><p>TL取得が一番時間がかかった部分です。</p><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/main/misskey/gettimeline.go target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/main/misskey/gettimeline.go</a></p><p>このコードの話です。</p><p>タイムライン取得は、トークンと表示数をリクエストボディに入れ、エンドポイント先を指定することでローカル/グローバル/ホームのTLを指定表示件数分取得することが出来ます。</p><p>ドキュメント:</p><ul><li>ローカルTL: <a class=link href=https://misskey-hub.net/docs/api/endpoints/notes/local-timeline.html target=_blank rel=noopener>https://misskey-hub.net/docs/api/endpoints/notes/local-timeline.html</a></li><li>グローバルTL: <a class=link href=https://misskey-hub.net/docs/api/endpoints/notes/global-timeline.html target=_blank rel=noopener>https://misskey-hub.net/docs/api/endpoints/notes/global-timeline.html</a></li><li>ホームTL: <a class=link href=https://misskey-hub.net/docs/api/endpoints/notes/timeline.html target=_blank rel=noopener>https://misskey-hub.net/docs/api/endpoints/notes/timeline.html</a></li></ul><p>例えば、ローカルTLの取得(最新2件)をcurlでやるとすると、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl -X POST -d &#39;{i:hogehugaToken, limit:2}&#39; https://misskey.io/api/notes/local-timeline</span></span></code></pre></td></tr></table></div></div></div></div><p>となります。</p><p>実際にcurlで最新1件のノートを取得してみると、こんなJSONが降ってきます。(とりあえず1件)、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>id:</span> <span class=err>98iwcr1ime,</span>
</span></span><span class=line><span class=cl>    <span class=err>createdAt:</span> <span class=err>2022-12-08T17:07:49.350Z,</span>
</span></span><span class=line><span class=cl>    <span class=err>userId:</span> <span class=err>8rhxi7gw77,</span>
</span></span><span class=line><span class=cl>    <span class=err>user:</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>      <span class=err>id:</span> <span class=err>8rhxi7gw77,</span>
</span></span><span class=line><span class=cl>      <span class=err>name:</span> <span class=err>null,</span>
</span></span><span class=line><span class=cl>      <span class=err>username:</span> <span class=err>mikuta0407,</span>
</span></span><span class=line><span class=cl>      <span class=err>host:</span> <span class=err>null,</span>
</span></span><span class=line><span class=cl>      <span class=err>avatarUrl:</span> <span class=err>https:</span><span class=c1>//s3.arkjp.net/misskey/thumbnail-b13bb7e7-c86b-47f4-bed7-aee75c5febf6.webp,
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=err>avatarBlurhash:</span> <span class=err>yILWR+-U7fS$xGX9s900WB9cR-xskCWBAwR*</span><span class=p>}</span><span class=err>TsmWBnPOE~CRk-pxaIVaes.Ads:xZjbNaS#r@%gkCNFWBWXi</span><span class=p>{</span><span class=err>tQ=yjZI;R*xGt6WC,</span>
</span></span><span class=line><span class=cl>      <span class=err>avatarColor:</span> <span class=err>null,</span>
</span></span><span class=line><span class=cl>      <span class=err>emojis:</span> <span class=err>[],</span>
</span></span><span class=line><span class=cl>      <span class=err>onlineStatus:</span> <span class=err>online,</span>
</span></span><span class=line><span class=cl>      <span class=err>driveCapacityOverrideMb:</span> <span class=err>null</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=err>text:</span> <span class=err>お腹空いてきちゃった・・・</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>cw:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>visibility:</span> <span class=err>public</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>renoteCount:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>repliesCount:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>reactions:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=err>emojis:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=err>fileIds:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=err>files:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=err>replyId:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=err>renoteId:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></td></tr></table></div></div></div></div><p>こんな感じでjson配列がもらえます。この配列を<code>jsonparser.ArrayEach</code>を使って要素ごとに処理しTL表示をしています。</p><p>TLを構築する投稿のパターンは通常投稿・リプライ・リノートの3つがあります。執筆時点では引用リノートに非対応ですが(ごめんなさい)、これら3つのパターン分けは、</p><ul><li><code>renoteId</code>があるか→あればリノート</li><li><code>replyId</code>があるか→あればリプライ投稿</li><li>両方無かったら→通常投稿 という分岐で行うことが出来ます。</li></ul><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/gettimeline.go#L59-L96 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/gettimeline.go#L59-L96</a></p><h3 id=通常投稿>通常投稿</h3><p>通常投稿の場合は、上記例のパターンのJSONが降ってきます。</p><p>そして、コンソールへの表示は</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/12/14 23:29:29 名前(@ID)        本文    (添付有り)(98abcdef)</span></span></code></pre></td></tr></table></div></div></div></div><p>といったようにするため、JSONの中で必要なものは - 投稿者名(<code>user.name</code>)</p><ul><li>投稿者ID(<code>user.username</code>)(@hogeで始まるもの)</li><li>投稿者インスタンスホスト名(<code>user.host</code>)(@hoge@<strong>misskey.io</strong>の部分)</li><li>投稿時間(<code>createdAt</code>)</li><li>本文(<code>text</code>)</li><li>投稿ID(<code>id</code>)</li><li>猫フラグ(<code>user.isCat</code>)</li><li>添付ファイル情報(<code>files</code>) となります。</li></ul><p>これらを取り出しているのが、<code>pickNote</code>関数となります。</p><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/gettimeline.go#L111-L158 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/gettimeline.go#L111-L158</a></p><p>この関数に投稿のjson配列の1要素のバイト列を渡すし、新規投稿のところでも書いた<code>jsonparser</code>を使って、json用の構造体の宣言なしに値を取り出しをしています。(<code>noteData</code>という取り出した値を入れる構造体は作っています。)</p><p>hostに記載があれば他インスタンス投稿なのでそのホスト名を表示したり、isCatのフラグがあれば名前の後に<code>(Cat)</code>を付加して猫であることをわかるようにしたり、添付ファイルが1つでもあれば<code>(添付あり)</code>と表示するなどしたりなど、簡易的な閲覧であれば十分と思われる情報量を表示しています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>noteData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>offset</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span>      <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>attach</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span>        <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>isCat</span>     <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>pickNote</span><span class=p>(</span><span class=nx>value</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>noteData</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>note</span> <span class=nx>noteData</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 投稿者
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>note</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//投稿者ID
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>note</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>note</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//ホスト名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>note</span><span class=p>.</span><span class=nx>host</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>host</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>note</span><span class=p>.</span><span class=nx>username</span> <span class=p>=</span> <span class=nx>note</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=err>@</span> <span class=o>+</span> <span class=nx>note</span><span class=p>.</span><span class=nx>host</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 投稿時刻
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>note</span><span class=p>.</span><span class=nx>timestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>createdAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>note</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>ParseInLocation</span><span class=p>(</span><span class=mi>2006</span><span class=o>-</span><span class=mo>01</span><span class=o>-</span><span class=mo>02</span><span class=nx>T15</span><span class=p>:</span><span class=mo>04</span><span class=p>:</span><span class=mo>05</span><span class=nx>Z</span><span class=p>,</span> <span class=nx>note</span><span class=p>.</span><span class=nx>timestamp</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>UTC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>note</span><span class=p>.</span><span class=nx>timestamp</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>In</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Local</span><span class=p>).</span><span class=nf>Format</span><span class=p>(</span><span class=mi>2006</span><span class=o>/</span><span class=mo>01</span><span class=o>/</span><span class=mo>02</span> <span class=mi>15</span><span class=p>:</span><span class=mo>04</span><span class=p>:</span><span class=mo>05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 本文
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>note</span><span class=p>.</span><span class=nx>text</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//投稿ID(元投稿)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>note</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetString</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>note</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//ねこかどうか
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>isCat</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>GetBoolean</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>isCat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>isCat</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>note</span><span class=p>.</span><span class=nx>name</span> <span class=p>=</span> <span class=nx>note</span><span class=p>.</span><span class=nx>name</span> <span class=o>+</span> <span class=p>(</span><span class=nx>Cat</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ファイルが有れば
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>filesId</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>files</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>filesId</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>note</span><span class=p>.</span><span class=nx>attach</span> <span class=p>=</span>    <span class=p>(</span><span class=nx>添付有り</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>note</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>ちなみに、名前欄を赤色にしたり、添付がある場合に緑、投稿IDを青にしているは、<code>\x1b[35m%s(@%s)\x1b[0m\t</code>といったようなエスケープシーケンスを使って、標準出力側で装飾を指定することで実装しています。(リプライの場合はピンクに)</p><h4 id=リプライ-1>リプライ</h4><p>リプライがある場合は、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2022/12/14 23:55:06 名前(@ID@host)     リプライ元の投稿    (98xxxxxxxx)
</span></span><span class=line><span class=cl>    2022/12/14 23:56:38 名前(@ID@host)     リプライ投稿の本文    (添付有り)(98aaaaaaaa)</span></span></code></pre></td></tr></table></div></div></div></div><p>といったように表示されます。</p><p>一見リプライ元の投稿の情報を別に取りに行ってるように見えますが、実際はリプライの投稿のJSON内に<code>reply</code>という要素があり、その中に通常投稿と同じデータ構造で投稿内容が入っています。なので、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>replyParentValue</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>replyParent</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>pickNote</span><span class=p>(</span><span class=nx>replyParentValue</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>と書くだけで、リプライ元の投稿の情報を<code>pickNote</code>を使って持ってくることが出来るのです。</p><p>また、リプライはぶら下がっている印象があるので、<code>noteData</code>構造体にある<code>offset</code>にスペース4つをいれ、行頭に挿入することでぶら下がりを表現しています。</p><h4 id=リノート-1>リノート</h4><p>リノートの表示方法もリプライのリプライ元表示に似ています。リプライが<code>reply</code>要素に投稿が入っていたのと同様に、リノートでも<code>renote</code>要素に投稿が入っているので、<code>renote</code>要素を取り出したものを<code>pickNote</code>に渡すことで投稿内容を取得しています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>renoteValue</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>jsonparser</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>renote</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>note</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>pickNote</span><span class=p>(</span><span class=nx>renoteValue</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>また、リノートの場合は行頭に<code>[RN]</code>を付加することでリノートであることを表現しています。</p><h3 id=その他表示に関わる部分いつかなにか改善したら追記>その他表示に関わる部分(いつかなにか改善したら追記)</h3><h4 id=1行の文字数>1行の文字数</h4><p><img src=/img/CQPvwPK.png loading=lazy></p><p><img src=/posts/2022/20221216-misskey-cli/img/18Q90SD.jpg width=3100 height=1974 srcset="/posts/2022/20221216-misskey-cli/img/18Q90SD_huef44955d97f1b701c4935c959c937c0c_144711_480x0_resize_q75_box.jpg 480w, /posts/2022/20221216-misskey-cli/img/18Q90SD_huef44955d97f1b701c4935c959c937c0c_144711_1024x0_resize_q75_box.jpg 1024w" loading=lazy class=gallery-image data-flex-grow=157 data-flex-basis=376px></p><p>misskey-cliでコマンドを叩くと、ヘッダ部分の「=======」の長さがコンソールの幅によって変わることがわかります。</p><p>この「=======」を表示するのは各機能の関数で<code>fmt.Println</code>内に書かれている<code>printLine()</code>という関数が表示しています。</p><p>このprintLine()は</p><p><a class=link href=https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/misskey.go#L59-L70 target=_blank rel=noopener>https://github.com/mikuta0407/misskey-cli/blob/67d17a15d3bff0e7c258f42a61b5d99679e2d164/misskey/misskey.go#L59-L70</a></p><p>でこのように記述しています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>printLine</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>width</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>terminal</span><span class=p>.</span><span class=nf>GetSize</span><span class=p>(</span><span class=nx>syscall</span><span class=p>.</span><span class=nx>Stdin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=nx>Error</span> <span class=p>:</span> <span class=o>%+</span><span class=nx>v</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;=</span> <span class=nx>width</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(=)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=err>\</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>terminal.GetSize(syscall.Stdin)</code>はターミナルの横幅を取得する関数です。これで貰えた幅の文字数分、「=」を表示することが出来ます。</p><p>……実はこれのせいでmisskey-cliはWindows版がありません。WSL1で動くので許して下さい……。</p><h2 id=まとめ>まとめ</h2><p>やったことをダラダラと書く記事になってしまいましたが、ここまで耐えて読んでくださった方、ありがとうございます。</p><p>初めて非身内なアドカレに参加し、あまりにも強い方々の投稿を見て焦りのような緊張を感じつつ書いていました。(その割に執筆中に未実装機能に気づくなどしていましたが・・・)</p><p>今年は色んな意味でFediverseが話題となり、Misskeyにもいろんな投稿が流れてTLが賑わっているのを楽しく見ています。今年はMisskeyでもあけおめ投稿してみようかな・・・</p><p>そしてTUI版を作ってみようかな・・・(完成するとは言ってない)</p><p>ありがとうございました!</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>関連するコンテンツ</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/2020/20200213-wakeonlan-from-browser/><div class=article-details><h2 class=article-title>ブラウザ経由でシェルスクリプト叩いてWake on LANする</h2></div></a></article><article class=has-image><a href=/posts/2023/20230807-making-of-x-bot-for-kuchiwohiraku/><div class=article-image><img src=/posts/2023/20230807-making-of-x-bot-for-kuchiwohiraku/img/_hued2eb23146221757a2e86c10559b40be_153251_9451e750af6e0a0d5c87d573b8635829.png width=250 height=150 loading=lazy alt="Featured image of post リスナーが勝手にPodcast番組の更新通知Botを作って遊んだ話" data-hash="md5-lk0yEBClDccxxfFbS+sZXA=="></div><div class=article-details><h2 class=article-title>リスナーが勝手にPodcast番組の更新通知Botを作って遊んだ話</h2></div></a></article><article class=has-image><a href=/posts/2021/20211203-tcu-yc-summary-in-md-and-pandoc/><div class=article-image><img src=/posts/2021/20211203-tcu-yc-summary-in-md-and-pandoc/img/_hu73fe6da212d5787cddaafb2e3107eb90_571990_17c4b211a4b63357bc670ccb677766a4.png width=250 height=150 loading=lazy alt="Featured image of post 都市大YCの卒業研究概要集をMarkdownで快適に書くためのPandoc環境セットアップ備忘録" data-hash="md5-pF1ewOd52gW7v52ttCdXbA=="></div><div class=article-details><h2 class=article-title>都市大YCの卒業研究概要集をMarkdownで快適に書くためのPandoc環境セットアップ備忘録</h2></div></a></article><article><a href=/posts/2021/20210306-subsonic-with-googledrive/><div class=article-details><h2 class=article-title>SubsonicのストレージとしてGoogleDriveを使う方法(Linux)</h2></div></a></article><article><a href=/posts/2020/20201209-2-click-tcu-attend-system/><div class=article-details><h2 class=article-title>大学の出席確認システムへ2クリックで登録できるシステムの構築</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2024 mikuta0407</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>