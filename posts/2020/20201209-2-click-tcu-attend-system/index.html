<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='この記事はTokyo City University Advent Calendar 2020の9日目の記事です。 昨日の記事は @aqp_nmu さんによる &ldquo;それっぽい"配信環境を整えてきもちよ'><title>大学の出席確認システムへ2クリックで登録できるシステムの構築</title>
<link rel=canonical href=https://blog.mikuta0407.net/posts/2020/20201209-2-click-tcu-attend-system/><link rel=stylesheet href=/scss/style.min.01b3ec666d6f6bb6342716ec85d85dcf1a50190d2a63506d495d154e2fd852b8.css><meta property='og:title' content="大学の出席確認システムへ2クリックで登録できるシステムの構築"><meta property='og:description' content='この記事はTokyo City University Advent Calendar 2020の9日目の記事です。 昨日の記事は @aqp_nmu さんによる &ldquo;それっぽい"配信環境を整えてきもちよ'><meta property='og:url' content='https://blog.mikuta0407.net/posts/2020/20201209-2-click-tcu-attend-system/'><meta property='og:site_name' content='平和に生きたい'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2020-12-09T00:00:00+09:00'><meta property='article:modified_time' content='2020-12-09T00:00:00+09:00'><meta name=twitter:title content="大学の出席確認システムへ2クリックで登録できるシステムの構築"><meta name=twitter:description content='この記事はTokyo City University Advent Calendar 2020の9日目の記事です。 昨日の記事は @aqp_nmu さんによる &ldquo;それっぽい"配信環境を整えてきもちよ'><script data-goatcounter=https://stats.mikuta0407.net/count async src=https://mikuta0407.net/files/goatcounter.js></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/mikuta0407-icon_hua8f22b6667bbcefae8d1b7d0dca296d9_162513_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>平和に生きたい</a></h1><h2 class=site-description>mikuta0407の書いた虚無。ﾖﾜﾖﾜ技術系からアイマスとかガジェットとかごった煮。</h2></div></header><ol class=menu-social><li><a href=https://github.com/mikuta0407 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/mikuta0407 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目次</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#はじめに>はじめに</a></li><li><a href=#まずは動作サンプル>まずは動作サンプル</a></li><li><a href=#特徴>特徴</a></li><li><a href=#ブラウザとかを使うマシン以外に必要なもの>ブラウザとかを使うマシン以外に必要なもの</a></li><li><a href=#webサーバーの準備>Webサーバーの準備</a><ol><li><a href=#apache2とnkfのインストール>Apache2とnkfのインストール</a></li><li><a href=#疎通確認>疎通確認</a></li><li><a href=#cgidの有効化>cgidの有効化</a></li><li><a href=#cgi-binのディレクトリの変更シェルスクリプトをcgiとして動かせるようにする>cgi-binのディレクトリの変更+シェルスクリプトをCGIとして動かせるようにする</a></li><li><a href=#動作確認>動作確認</a></li></ol></li><li><a href=#実プログラムの配置>実プログラムの配置</a><ol><li><a href=#ディレクトリ作成>ディレクトリ作成</a></li><li><a href=#シェルスクリプト>シェルスクリプト</a></li><li><a href=#html>HTML</a></li></ol></li><li><a href=#chrome拡張化する>Chrome拡張化する</a></li><li><a href=#プログラム構築までの道のり>プログラム構築までの道のり</a><ol><li><a href=#めんどくさかったところ>めんどくさかったところ</a></li><li><a href=#ログイン処理>ログイン処理</a><ol><li><a href=#動作を調べる>動作を調べる</a></li><li><a href=#curlでやってみる>curlでやってみる</a></li></ol></li><li><a href=#ログイン失敗処理>ログイン失敗処理</a><ol><li><a href=#動作を調べる-1>動作を調べる</a></li><li><a href=#curlとgrepでやってみる>curlとgrepでやってみる</a></li></ol></li><li><a href=#時間外処理>時間外処理</a><ol><li><a href=#動作を調べる-2>動作を調べる</a></li><li><a href=#ifで判定してみる>ifで判定してみる</a></li></ol></li><li><a href=#本番処理>本番処理</a><ol><li><a href=#動作を調べる-3>動作を調べる</a></li><li><a href=#curlでやってみる-1>curlでやってみる</a></li></ol></li><li><a href=#実環境用ファイル作成>実環境用ファイル作成</a><ol><li><a href=#シェルスクリプト-1>シェルスクリプト</a></li><li><a href=#ログイン処理-1>ログイン処理</a></li><li><a href=#ログイン失敗処理-1>ログイン失敗処理</a></li><li><a href=#ログイン成功時間外処理>ログイン成功→時間外処理</a></li><li><a href=#本番処理-1>本番処理</a></li><li><a href=#htmlファイル>HTMLファイル</a></li></ol></li></ol></li><li><a href=#おまけ1-idとパスワードをシェルスクリプトから分離して保存する>おまけ1: IDとパスワードをシェルスクリプトから分離して保存する</a></li><li><a href=#おまけ2公開鯖向け-一応robotstxtを書く>おまけ2(公開鯖向け): 一応robots.txtを書く</a></li><li><a href=#おまけ3-discordのbotにしてみる>おまけ3: DiscordのBotにしてみる</a></li><li><a href=#〆>〆</a></li><li><a href=#宣伝>宣伝</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E7%9B%86%E6%A0%BD%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E9%96%8B%E7%99%BA/>盆栽システム開発
</a><a href=/categories/php/>PHP</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2020/20201209-2-click-tcu-attend-system/>大学の出席確認システムへ2クリックで登録できるシステムの構築</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2020-12-09</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>読了時間: 26分</time></div></footer></div></header><section class=article-content><p>この記事は<a class=link href=https://adventar.org/calendars/5110 target=_blank rel=noopener>Tokyo City University Advent Calendar 2020</a>の9日目の記事です。</p><p>昨日の記事は <a class=link href=https://twitter.com/aqp_nmu target=_blank rel=noopener>@aqp_nmu</a> さんによる <a class=link href=https://yurufuwa-atelier.hatenablog.jp/entry/2020/12/08/000000 target=_blank rel=noopener>&ldquo;それっぽい"配信環境を整えてきもちよくなろう - ふとんのなか</a> でした!</p><p>よく見かけるあの配信画面はこんな感じで作るのか・・・と勉強になりました。<br>特に2560x1440にしておけばFHDがそのまま置けるしサイズ感もいい感じ、というのが驚きで・・・。確かにそうなんですが、すごい発想ですよね。</p><p>さて、今日の記事はフロッピーでもMS-DOSでもWindows95でもなく、シェルスクリプトを使ったお話です。 <a class=link href=https://ke9000.hatenablog.com/entry/nativeJS_01 target=_blank rel=noopener>ケーさんの好きなJSじゃないよ!</a> Shell Scriptだよ!</p><p>構成としては説明→配布→内容解説なので、是非内容解説まで読んでいただけると幸いです(長いですけど)</p><h2 id=はじめに>はじめに</h2><p>都市大生のみなさんはいつも<del>使わされてる</del>お世話になっている都市大の出席確認システムですが、毎回</p><ol><li>アクセスしてログイン</li><li>番号を選ぶ</li><li>教科を選ぶ</li><li>登録</li><li>登録完了!</li></ol><p>という、地味に手数の多い作業を行います。別に構わないといえば構わないのですが、少ない手数で出席確認の登録ができれば、非常に楽になります。</p><p>そこで、今回は出席確認を</p><ul><li>ページにアクセス</li><li>数字をクリック</li><li>登録完了!</li></ul><p>のように非常にかんたんな手順で済むようなシステムの構築をしてみました。</p><p>タイトルに2クリックとありますが、これはChrome拡張化することで、拡張のボタンクリック→数字クリックの2回にできるものとなっています。もちろんChrome拡張にしなくてもブックマークでも同じですので、ぜひ試してみてください。(<strong>Chrome拡張配布もあるよ!</strong>)</p><h2 id=まずは動作サンプル>まずは動作サンプル</h2><p>サイトにアクセスするとこうなります<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/4004b6a1-8eb5-f7e0-dbbf-86f4dae400cf_huafbeeb1ad3a85968cf4c54d6655abdbd_20684_422x372_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/4004b6a1-8eb5-f7e0-dbbf-86f4dae400cf.png width=422 height=372 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/4004b6a1-8eb5-f7e0-dbbf-86f4dae400cf_huafbeeb1ad3a85968cf4c54d6655abdbd_20684_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/4004b6a1-8eb5-f7e0-dbbf-86f4dae400cf_huafbeeb1ad3a85968cf4c54d6655abdbd_20684_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=113 data-flex-basis=272px></picture></p><p>数字ボタンを押すだけで出席登録できますので、このページをブックマークに登録しておけば、「ブックマーククリック→番号ボタンクリック」の2クリックになりますね。(ブラウザが変わった? 気にしないでください・・。)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/g2Dzkyy_hudb6719319fbfaaaae07ccf74c54fc113_16634_426x291_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/g2Dzkyy.png width=426 height=291 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/g2Dzkyy_hudb6719319fbfaaaae07ccf74c54fc113_16634_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/g2Dzkyy_hudb6719319fbfaaaae07ccf74c54fc113_16634_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=146 data-flex-basis=351px></picture></p><p>時間外にアクセスすると、ちゃんとエラーが出ます。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/1fd6417d-94ca-9b16-f49c-7df2343f451f_hua5144dc31af306a866133128039bc064_14884_661x183_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/1fd6417d-94ca-9b16-f49c-7df2343f451f.png width=661 height=183 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/1fd6417d-94ca-9b16-f49c-7df2343f451f_hua5144dc31af306a866133128039bc064_14884_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/1fd6417d-94ca-9b16-f49c-7df2343f451f_hua5144dc31af306a866133128039bc064_14884_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=361 data-flex-basis=866px></picture></p><h2 id=特徴>特徴</h2><ul><li>puppeteerなどの重いソフトを使用していないので、サーバリソースが小規模で済む</li><li>シェルスクリプトかつ使用コマンドは基本ツールだらけなので、アーキテクチャ依存は一切ない(ただしshじゃなくbash依存です。zshはわかりません)</li></ul><h2 id=ブラウザとかを使うマシン以外に必要なもの>ブラウザとかを使うマシン以外に必要なもの</h2><ul><li>Bashが使えてインターネットに出れるLinux機<ul><li>VPSのように、どこからでもアクセスできるほうが便利ですが、URLが漏れると誰でも出席確認登録が行えてしまうので、そこは注意してください。(とはいえ誰がやろうが設置した人の出席確認になってしまうだけなのでリスクは微妙)<ul><li>適切に設置すればパスワードが漏れることはほぼ無いです</li><li>WindowsならWSLでやるというスタンドアロンな手段もあります。</li><li>もちろんLinuxをメイン機として使ってる人はその中でもどうぞ</li></ul></li></ul></li></ul><h2 id=webサーバーの準備>Webサーバーの準備</h2><p>今回は説明用環境にRaspberry Pi Zero+Raspbianを利用していますので、もろもろのパスとかコマンドはDebian系になっています。<br>違うディストリを使う場合は適宜変更してください。<br>また、説明に使用しているアドレスは<code>http://example.com/</code>です。ここも適宜読み替えてください。</p><h3 id=apache2とnkfのインストール>Apache2とnkfのインストール</h3><p>WebサーバーとなるApacheと、SJISで送られてくるサイトをUTF-8で処理するための文字コード変換のためのnkfを入れます。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt upgrade
</span></span><span class=line><span class=cl>sudo apt install apache2 nkf</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=疎通確認>疎通確認</h3><p>アクセスしてみて、デフォルトページが表示されていればOKです。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/ecadd7e8-bad5-3601-ec56-164ea9eba42f_hu2208816c8f8a0bfb9256848aa429d86b_47638_840x351_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/ecadd7e8-bad5-3601-ec56-164ea9eba42f.png width=840 height=351 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/ecadd7e8-bad5-3601-ec56-164ea9eba42f_hu2208816c8f8a0bfb9256848aa429d86b_47638_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/ecadd7e8-bad5-3601-ec56-164ea9eba42f_hu2208816c8f8a0bfb9256848aa429d86b_47638_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=239 data-flex-basis=574px></picture></p><h3 id=cgidの有効化>cgidの有効化</h3><p>CGIを使えるように、モジュールの有効化をします</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo a2enmod cgid</span></span></code></pre></td></tr></table></div></div></div></div><p>Apache2を再起動します</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart apache2</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=cgi-binのディレクトリの変更シェルスクリプトをcgiとして動かせるようにする>cgi-binのディレクトリの変更+シェルスクリプトをCGIとして動かせるようにする</h3><p>デフォルトだと、CGIのディレクトリが<code>/usr/lib/cgi-bin</code>のため、コンソールからのアクセス性が悪くなっています(HTMLファイルは<code>/var/www/html</code>なので)。<br>そこで、ディレクトリを<code>/var/www/cgi-bin</code>に変更した上で、ついでにシェルスクリプト(<code>.sh</code>)もCGIだよって教えてあげます。そうしないとCGIとしてシェルスクリプトが動かないので・・・。</p><p>まず、以下がデフォルトの設定(抜粋)です。Directoryが<code>/usr/lib/cgi-bin</code>になっていますね。</p><div><div class=codeblock--name>/etc/apache2/conf-available/serve-cgi-bin.conf</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
</span></span><span class=line><span class=cl><span class=nt>&lt;Directory</span> <span class=err>&#34;/usr/lib/cgi-bin&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>	AllowOverride None
</span></span><span class=line><span class=cl>	Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
</span></span><span class=line><span class=cl>	Require all granted
</span></span><span class=line><span class=cl><span class=nt>&lt;/Directory&gt;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>これを、以下のように変更します</p><div><div class=codeblock--name>/etc/apache2/conf-available/serve-cgi-bin.conf</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>ScriptAlias /cgi-bin/ /var/www/cgi-bin/
</span></span><span class=line><span class=cl><span class=nt>&lt;Directory</span> <span class=err>&#34;/var/www/cgi-bin&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>	AllowOverride None
</span></span><span class=line><span class=cl>	Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
</span></span><span class=line><span class=cl>	Require all granted
</span></span><span class=line><span class=cl><span class=nt>&lt;/Directory&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># .shもCGI
</span></span><span class=line><span class=cl>AddHandler cgi-script .sh</span></span></code></pre></td></tr></table></div></div></div></div><p>変更を適用するために、Apache2を再起動します。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart apache2</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=動作確認>動作確認</h3><p>本当にCGIとしてシェルスクリプトが動くのか実験します。</p><p>以下のシェルスクリプトを<code>/var/www/cgi-bin/test.sh</code>として保存します。(cgi-binフォルダは多分無いので作ってください)</p><div><div class=codeblock--name>/var/www/cgi-bin/test.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#↑ bashで動いてもらいます。bash依存してなければ#!/bin/shでもOK</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># レスポンスヘッダ(なにかサイトで文字を返す前にはこれが必要です)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以下自由</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hello World!&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>実行権限を付与します。個人サーバーでユーザーは一人しかいないので、めんどくさいので777にします。(複数人で使用してたりする場合は適宜適切に設定してください。)</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod <span class=m>777</span> test.sh</span></span></code></pre></td></tr></table></div></div></div></div><p>これでアクセスすると、Hello Worldが表示されるはずです。(アドレスは<code>http://サーバーアドレス/cgi-bin/test.sh</code>)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/d83afb1a-c06a-7e5c-e514-18875cda8766_huee1d609d5cd81003e92307cb9cb1ff64_6707_458x99_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/d83afb1a-c06a-7e5c-e514-18875cda8766.png width=458 height=99 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/d83afb1a-c06a-7e5c-e514-18875cda8766_huee1d609d5cd81003e92307cb9cb1ff64_6707_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/d83afb1a-c06a-7e5c-e514-18875cda8766_huee1d609d5cd81003e92307cb9cb1ff64_6707_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=462 data-flex-basis=1110px></picture></p><h2 id=実プログラムの配置>実プログラムの配置</h2><p>どうやって作ったかはいらん! 早く中身をよこせ!っていう人もいる(かもしれない)ので、まずは設置と使い方を書きます。</p><h3 id=ディレクトリ作成>ディレクトリ作成</h3><p>HTMLを取得して保存して作業をするので、その作業ディレクトリの作成と、www-dataがそのフォルダを読み書きできるようにchownで所有者を変更します。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir /var/www/cgi-bin/htmlcache
</span></span><span class=line><span class=cl>sudo chown www-data:www-data /var/www/cgi-bin/htmlcache</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=シェルスクリプト>シェルスクリプト</h3><p>このシェルスクリプトが処理の全てです。内容は後で説明します。</p><p>以下を<strong>uidとpassを自分のものに置き換えてから</strong>保存したあと、ちゃんと実行権限の付与をしてあげてください。<br>(この平文保存部分に関して、文句言いたい人がいるかも知れませんが、まぁCGIなのでそう簡単に漏れないのと、後述する方法でギリギリ対策(?)ができますので許してください。)</p><p>Gist: <a class=link href=https://gist.github.com/mikuta0407/9464d86a597b9a08660387e3a9dcdff1 target=_blank rel=noopener>https://gist.github.com/mikuta0407/9464d86a597b9a08660387e3a9dcdff1</a></p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># ログイン処理</span>
</span></span><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php -d <span class=s2>&#34;uid=ログインID&#34;</span> -d <span class=s2>&#34;pass=パスワード&#34;</span> -d <span class=s2>&#34;menuname=%8Fo%90%C8&#34;</span> -d <span class=s2>&#34;module=Default&#34;</span> -d <span class=s2>&#34;action=Login&#34;</span> <span class=p>|</span> nkf &gt; /var/www/cgi-bin/htmlcache/selectkamoku.html
</span></span><span class=line><span class=cl><span class=c1># selectkamoku.htmlがログイン後のページ全てなので、以下はすべてこれを利用して処理</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ログイン可否判定</span>
</span></span><span class=line><span class=cl>cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=p>|</span> grep パスワード &gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=c1># ログイン失敗</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	cat /var/www/cgi-bin/htmlcache/selectkamoku.html
</span></span><span class=line><span class=cl>	<span class=nb>exit</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=c1># ログイン成功のとき</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 時間外かどうかを判定</span>
</span></span><span class=line><span class=cl>	cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=p>|</span> grep 現在時間に &gt; /dev/null
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>		<span class=c1># 時間外のとき</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;&lt;b&gt;時間外&lt;/b&gt;&lt;br&gt;&lt;br&gt;&#34;</span>
</span></span><span class=line><span class=cl>		cat /var/www/cgi-bin/htmlcache/selectkamoku.html
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=k>else</span>
</span></span><span class=line><span class=cl>		<span class=c1># 時間内で登録ができるとき</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=c1># セッションID持ってくる</span>
</span></span><span class=line><span class=cl>		<span class=nv>sessid</span><span class=o>=</span><span class=sb>`</span>cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=p>|</span> grep <span class=s2>&#34;PHPSESSID&#34;</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/&lt;form action=&#34;index.php&#34; method=&#34;post&#34;&gt;&lt;input type=&#34;hidden&#34; name=&#34;PHPSESSID&#34; value=&#34;//g&#39;</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/&#34; \/&gt;//g&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># 科目の番号</span>
</span></span><span class=line><span class=cl>		<span class=nv>selkamoku</span><span class=o>=</span><span class=sb>`</span>cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=p>|</span> grep <span class=s1>&#39;[0-9]\{4\},[0-9]\{8\}&#39;</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/&lt;option value=&#34;//g&#39;</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/&#34;&gt;.*//g&#39;</span> <span class=p>|</span> sed -n 1p<span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># 出席登録</span>
</span></span><span class=line><span class=cl>		curl -X POST https://call.off.tcu.ac.jp/index.php --cookie <span class=s2>&#34;PHPSESSID=</span><span class=si>${</span><span class=nv>sessid</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;module=Sk&#34;</span> -d <span class=s2>&#34;action=ProcedureAcc&#34;</span> -d  <span class=s2>&#34;SelKamoku=</span><span class=si>${</span><span class=nv>selkamoku</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;InpNo=</span><span class=si>${</span><span class=nv>1</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;submitButtonName=%8Fo%90%C8%93o%98%5E&#34;</span> <span class=p>|</span> nkf &gt; /var/www/cgi-bin/htmlcache/success.html
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=c1># 最終結果表示</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;&lt;b&gt;登録処理&lt;/b&gt;&lt;br&gt;&lt;br&gt;&#34;</span>
</span></span><span class=line><span class=cl>		cat /var/www/cgi-bin/htmlcache/success.html
</span></span><span class=line><span class=cl>	<span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=html>HTML</h3><p>CGIへのリンクボタンを表示してあげるHTMLです。
例によってリンクは適宜置き換えてください。</p><p>Gist: <a class=link href=https://gist.github.com/mikuta0407/5cda31aaf49789deaf3dcb1c95363921 target=_blank rel=noopener>https://gist.github.com/mikuta0407/5cda31aaf49789deaf3dcb1c95363921</a></p><div><div class=codeblock--name>/var/www/html/tcu_attend.html</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>都市大出席<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;1&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?1&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;2&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?2&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;3&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?3&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;4&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?4&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;5&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?5&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;6&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?6&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;7&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?7&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;8&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?8&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;9&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?9&#39;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=chrome拡張化する>Chrome拡張化する</h2><p>拡張化といっても、単純に拡張機能で小さいウィンドウ内でページを表示するようにするだけです。iframeで実装しています。</p><p>実際に使用すると、こんな感じになります。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/6fe3e581-23e0-f0ca-319f-f2e6cdad262f_hua371c3b110b609be5bee98d554e06292_15957_269x321_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/6fe3e581-23e0-f0ca-319f-f2e6cdad262f.png width=269 height=321 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/6fe3e581-23e0-f0ca-319f-f2e6cdad262f_hua371c3b110b609be5bee98d554e06292_15957_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/6fe3e581-23e0-f0ca-319f-f2e6cdad262f_hua371c3b110b609be5bee98d554e06292_15957_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=83 data-flex-basis=201px></picture><br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/KFgNOzV_hu90274ca378ffd9ebafb5ea428021915a_15476_326x349_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/KFgNOzV.png width=326 height=349 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/KFgNOzV_hu90274ca378ffd9ebafb5ea428021915a_15476_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/KFgNOzV_hu90274ca378ffd9ebafb5ea428021915a_15476_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=93 data-flex-basis=224px></picture><br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/049b7bd0-ca18-fe23-aa16-26bd6753ca6a_hudc4d3e1a41410a123392e7c54666fcf1_14470_266x319_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/049b7bd0-ca18-fe23-aa16-26bd6753ca6a.png width=266 height=319 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/049b7bd0-ca18-fe23-aa16-26bd6753ca6a_hudc4d3e1a41410a123392e7c54666fcf1_14470_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/049b7bd0-ca18-fe23-aa16-26bd6753ca6a_hudc4d3e1a41410a123392e7c54666fcf1_14470_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=83 data-flex-basis=200px></picture></p><p>どのページにいても一瞬で「右上のボタンクリック→番号ボタンクリック」の2クリックで登録できるようになるので便利です。</p><p>一旦完成版としてChrome拡張のファイルを置いておきます。 <a class=link href=https://mikuta0407.net/files/tcuattend_chex.zip target=_blank rel=noopener>tcuattend_chex.zip</a></p><p>使い方:</p><ol><li>Zip内を展開(フォルダ付きで)</li><li>index.htmlにあるiframeで表示するリンクを書き換える</li><li>manifest.jsonのpermissionsを表示するリンクのトップページのようなリンクに<strong>書き換える</strong>(<a class=link href=http://hoge.com/attend/index.html target=_blank rel=noopener>http://hoge.com/attend/index.html</a> だったら、http://hoge.com/ にしておけばOK(本当のところこれでいいのかはわからない))</li><li>同梱のアイコンが著作権を回避?したやつなので、お好きに変える</li><li>Chromeの拡張でデベロッパーモードをオンにして、「パッケージ化されていない拡張機能を読み込む」から拡張機能を読ませる</li></ol><p>(こんな感じで崩れる場合は、iframeとbody自体のwidthをいじってあげてください。)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/31dc4023-6ded-9d93-ec79-a99f7444204a_hu79c38a9b3fea699adf03b63a7478493d_9843_278x306_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/31dc4023-6ded-9d93-ec79-a99f7444204a.png width=278 height=306 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/31dc4023-6ded-9d93-ec79-a99f7444204a_hu79c38a9b3fea699adf03b63a7478493d_9843_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/31dc4023-6ded-9d93-ec79-a99f7444204a_hu79c38a9b3fea699adf03b63a7478493d_9843_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=90 data-flex-basis=218px></picture></p><p>一応Chrome拡張内のコードを載せておきます。(アイコンは自由ですよ)<br>hoge.hogeとかは適宜置き換えてください。</p><div><div class=codeblock--name>manifest.json</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;manifest_version&#34;</span><span class=p>:</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;TCU_Attend_ChromeExtension&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;version&#34;</span><span class=p>:</span><span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&#34;description&#34;</span><span class=p>:</span><span class=s2>&#34;Chrome拡張でTCU出席管理システムを2クリックでやるやつ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;icons&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;16&#34;</span><span class=p>:</span><span class=s2>&#34;icon_16x16.ico&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&#34;browser_action&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;default_icon&#34;</span><span class=p>:</span><span class=s2>&#34;icon_400x400.png&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;default_title&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;default_popup&#34;</span><span class=p>:</span><span class=s2>&#34;index.html&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&#34;permissions&#34;</span><span class=p>:[</span><span class=s2>&#34;tabs&#34;</span><span class=p>,</span><span class=s2>&#34;https://example.com/*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><div><div class=codeblock--name>index.html</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>TCU_Attend_ChromeExtention<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>body</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>width</span><span class=p>:</span> <span class=mi>270</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>height</span><span class=p>:</span> <span class=mi>290</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nt>iframe</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>border</span><span class=p>:</span> <span class=mi>0</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>iframe</span> <span class=na>width</span><span class=o>=</span><span class=s>&#34;270px&#34;</span> <span class=na>height</span><span class=o>=</span><span class=s>&#34;290px&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://example.com/tcu_attend.html&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>iframe</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=プログラム構築までの道のり>プログラム構築までの道のり</h2><p>さて、アドカレなのでただ単純にプログラムを配布するだけではなく、どうやって作ったかを紹介します。</p><p>注: シェルコマンドは改行をしたものを記載していますが、見やすくするためだけなので、実際の処理は改行無しで問題ありません。</p><h3 id=めんどくさかったところ>めんどくさかったところ</h3><p><strong>授業時間じゃないと、実際の登録処理の仕様が調べられないしデバッグもできない</strong></p><p>これが最大の難所でした。</p><p>幸いログインそのものとログイン失敗は時間外でも行えるので、それは授業時間外でゆっくり行えましたが、本番処理に関してはそれができないので、演習授業系で自分の作業が終了し、少し時間が空いたときにPOSTログを収集する、といった作業をしていました。</p><h3 id=ログイン処理>ログイン処理</h3><p>Puppeteerなどであれば、実際に要素で叩けばいいのですが、今回はシェルスクリプトでやっているので、POSTを行うためにcurlを使用するようにします。</p><h4 id=動作を調べる>動作を調べる</h4><p>まずはChromeの検証画面を開きながら、ログインをしてみます。ログインをすると、Networkタブの<code>index.php</code>に、何をForm Dataとして送ったのかが記載されているので確認をします。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/d1a15cfb-8c22-ede1-f2f7-cdf78f221d41_hub7f370a69945c81008117e2f801ac3e3_71335_1276x609_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/d1a15cfb-8c22-ede1-f2f7-cdf78f221d41.png width=1276 height=609 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/d1a15cfb-8c22-ede1-f2f7-cdf78f221d41_hub7f370a69945c81008117e2f801ac3e3_71335_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/d1a15cfb-8c22-ede1-f2f7-cdf78f221d41_hub7f370a69945c81008117e2f801ac3e3_71335_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=209 data-flex-basis=502px></picture></p><p>Form Dataの欄に、いろいろと記載されています。どうやら、uid, pass, menuname, module, actionの5つを送信しているようです。</p><p>そして、menunameはデコードできないと言っていますが、**実は「出席」のSJISコードをURLエンコードされたものです。**あまりにもひどい。<del>SJISをやめろ</del><br>Form Data欄の上部にある<code>view URL encoded</code>をクリックすると、生の値が見れます。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/c838ea34-0bf8-2a5a-8537-cd2004e9e5f9_hu457214c3684292e0578817659855bd5d_8513_358x198_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/c838ea34-0bf8-2a5a-8537-cd2004e9e5f9.png width=358 height=198 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/c838ea34-0bf8-2a5a-8537-cd2004e9e5f9_hu457214c3684292e0578817659855bd5d_8513_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/c838ea34-0bf8-2a5a-8537-cd2004e9e5f9_hu457214c3684292e0578817659855bd5d_8513_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=180 data-flex-basis=433px></picture></p><h4 id=curlでやってみる>curlでやってみる</h4><p>ここまでで「https://call.off.tcu.ac.jp/index.php に対して、POSTでForm Dataとして5つのデータを投げればログインができる」ことがわかりました。<br>ではこれを実際にcurlでやってみます。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;uid=ログインID&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;pass=パスワード&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;menuname=%8Fo%90%8&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;module=Default&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;action=Login&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>-d</code>をつけるとFormDataとして付属させることができます。</p><p>実際に実行すると、このようになります。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/25e0c2db-b684-cb35-39c2-d0beb55ddb3d_hu0ae87e30fc5ca005c715e4f30a55d3b0_33841_1675x262_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/25e0c2db-b684-cb35-39c2-d0beb55ddb3d.png width=1675 height=262 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/25e0c2db-b684-cb35-39c2-d0beb55ddb3d_hu0ae87e30fc5ca005c715e4f30a55d3b0_33841_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/25e0c2db-b684-cb35-39c2-d0beb55ddb3d_hu0ae87e30fc5ca005c715e4f30a55d3b0_33841_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=639 data-flex-basis=1534px></picture></p><p>HTMLがShift-JISで書かれているので、UTF-8で表示しているコンソールでは化けてしまっています。シェルスクリプトでも文字列を扱っているので、UTF-8で扱えるよう、nkfを通してあげます。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;uid=ログインID&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;pass=パスワード&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;menuname=%8Fo%90%C8&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;module=Default&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;action=Login&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=p>|</span> nkf</span></span></code></pre></td></tr></table></div></div></div></div><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/25ea8a9a-782d-7883-7b4d-5d22e4daa3b3_hue6a21c688073b85ae455f0e556e86270_52813_1710x360_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/25ea8a9a-782d-7883-7b4d-5d22e4daa3b3.png width=1710 height=360 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/25ea8a9a-782d-7883-7b4d-5d22e4daa3b3_hue6a21c688073b85ae455f0e556e86270_52813_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/25ea8a9a-782d-7883-7b4d-5d22e4daa3b3_hue6a21c688073b85ae455f0e556e86270_52813_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=475 data-flex-basis=1140px></picture></p><p>無事にきれいに表示できるようになりました。<br>時間外のエラーが出ていますが、これが出ているということはログインに成功しているということです。
本番処理ではこのページに数字を選んだりする要素があるので、このHTMLデータを保存できるようにします。</p><p>注: シェルスクリプト作成段階ではsudoなしでシェルスクリプトを叩きたいので、ディレクトリをホームディレクトリ内で行っています。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;uid=ログインID&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;pass=パスワード&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;menuname=%8Fo%90%8&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;module=Default&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;action=Login&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=p>|</span> nkf &gt; selectkamoku.html</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=ログイン失敗処理>ログイン失敗処理</h3><h4 id=動作を調べる-1>動作を調べる</h4><p>とりあえず適当に間違っているユーザー名とパスワードでログインしてみます。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/cfea9456-2e85-05c2-f0c9-cef3b156d68f_hu477699167286c4fde60f4f420d45ae78_55644_1133x475_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/cfea9456-2e85-05c2-f0c9-cef3b156d68f.png width=1133 height=475 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/cfea9456-2e85-05c2-f0c9-cef3b156d68f_hu477699167286c4fde60f4f420d45ae78_55644_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/cfea9456-2e85-05c2-f0c9-cef3b156d68f_hu477699167286c4fde60f4f420d45ae78_55644_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=238 data-flex-basis=572px></picture></p><p>「IDまたはパスワードに誤りがあります」という表記がありますね。<br>そして、「パスワード」という単語は、ログイン画面以外ではログイン失敗のときにしか表示されません。<br>つまり、htmlに「パスワード」という文字が含まれていれば、ログイン失敗という判定ができるわけです。</p><h4 id=curlとgrepでやってみる>curlとgrepでやってみる</h4><p>まず、上記のcurlコマンドを使用して、誤ったログインID/パスワードを入力した時の返答を保存します。<br>catするとこうなります。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/1a066c7c-e5e8-a368-de8d-091ac9c6b305_hu4f6388524472045a97f75f10cc34f7c5_72566_1126x479_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/1a066c7c-e5e8-a368-de8d-091ac9c6b305.png width=1126 height=479 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/1a066c7c-e5e8-a368-de8d-091ac9c6b305_hu4f6388524472045a97f75f10cc34f7c5_72566_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/1a066c7c-e5e8-a368-de8d-091ac9c6b305_hu4f6388524472045a97f75f10cc34f7c5_72566_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=235 data-flex-basis=564px></picture><br>(ちなみにこの段階で、「セッション管理はPHPSESSIDを使えばいいんだな」という事もわかってしまいますね。(どうして時間外にはPHPSESSIDがなくて、失敗ではSESSIDが出てくるんでしょうね)</p><p>このselectkamoku.htmlをgrepして、「パスワード」という文字があった場合には・・・という処理をできるようにします。</p><p>まずは単純にgrepしてみます。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/3249fdae-7e3c-19d3-722b-0bb651653410_hu77c1dfd1f3af2b19cd2ad1900f82ce89_15404_804x74_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/3249fdae-7e3c-19d3-722b-0bb651653410.png width=804 height=74 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/3249fdae-7e3c-19d3-722b-0bb651653410_hu77c1dfd1f3af2b19cd2ad1900f82ce89_15404_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/3249fdae-7e3c-19d3-722b-0bb651653410_hu77c1dfd1f3af2b19cd2ad1900f82ce89_15404_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=1086 data-flex-basis=2607px></picture><br>出てきますね。</p><p>grepは、検索結果の有無で、ちゃんと戻り値があります。<br>戻り値は<code>$?</code>にありますので、確認をしてみます。<br>($?は、<code>?</code>という変数に戻り値が入っている・・・とでも思ってください。変数名の頭に$を付けてあげると変数として呼び出せます。)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/02ae5b42-6947-a1ca-a342-09e7555f20fa_hu2601c25633559f10dbe27f4bb122b734_11249_329x119_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/02ae5b42-6947-a1ca-a342-09e7555f20fa.png width=329 height=119 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/02ae5b42-6947-a1ca-a342-09e7555f20fa_hu2601c25633559f10dbe27f4bb122b734_11249_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/02ae5b42-6947-a1ca-a342-09e7555f20fa_hu2601c25633559f10dbe27f4bb122b734_11249_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=276 data-flex-basis=663px></picture><br>grepは、「検索結果があれば<strong>0</strong>」「検索結果がなければ<strong>1</strong>」というように<strong>結果があることが前提の戻り値</strong>を返してきます。</p><p>なので、以下のようなスクリプトを利用すれば、「あった場合はある、ない場合はないと表示する」などができます。(grepが吐き出す標準出力は/dev/nullに投げて闇に葬っています)</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat selectkamoku.html <span class=p>|</span> grep パスワード &gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;あった&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;なかった&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></td></tr></table></div></div></div></div><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/93a76cb8-4647-22e2-4c89-24e10df08e6a_hu4c3564eb96731a6894ba32d08effa090_15492_713x169_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/93a76cb8-4647-22e2-4c89-24e10df08e6a.png width=713 height=169 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/93a76cb8-4647-22e2-4c89-24e10df08e6a_hu4c3564eb96731a6894ba32d08effa090_15492_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/93a76cb8-4647-22e2-4c89-24e10df08e6a_hu4c3564eb96731a6894ba32d08effa090_15492_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=421 data-flex-basis=1012px></picture><br>これを実際にログインに成功した状態のHTMLでやると、<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/603bf390-6d23-1923-f74f-61e47fd36fe9_hu6bc67510d77d3de3335a89bc40b38fd1_17000_718x190_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/603bf390-6d23-1923-f74f-61e47fd36fe9.png width=718 height=190 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/603bf390-6d23-1923-f74f-61e47fd36fe9_hu6bc67510d77d3de3335a89bc40b38fd1_17000_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/603bf390-6d23-1923-f74f-61e47fd36fe9_hu6bc67510d77d3de3335a89bc40b38fd1_17000_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=377 data-flex-basis=906px></picture></p><p>無い方の処理が走ります。</p><h3 id=時間外処理>時間外処理</h3><h4 id=動作を調べる-2>動作を調べる</h4><p>これはログイン失敗の処理とほぼ似たようなことをやります。今回はログインできるIDとパスワードでログインします。<br>ログイン失敗のときしか現れない単語として「パスワード」がありましたが、時間外のときには<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/dd2af94e-e53a-9c27-e2f6-b7fa2124f849_hu535b96704f79271ecd1cc360a1b94cd5_29102_1140x292_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/dd2af94e-e53a-9c27-e2f6-b7fa2124f849.png width=1140 height=292 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/dd2af94e-e53a-9c27-e2f6-b7fa2124f849_hu535b96704f79271ecd1cc360a1b94cd5_29102_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/dd2af94e-e53a-9c27-e2f6-b7fa2124f849_hu535b96704f79271ecd1cc360a1b94cd5_29102_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=390 data-flex-basis=936px></picture><br>「現在時間」がキーワードになります。(なんとなく確実性を求めるために「現在時間に」まで使ってみています)</p><p>ちなみに時間外のページにたどり着ければ、ログインは成功していますので、本番処理でも同様に行ってください。</p><h4 id=ifで判定してみる>ifで判定してみる</h4><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat selectkamoku.html <span class=p>|</span> grep 現在時間に &gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;あった&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;なかった&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></td></tr></table></div></div></div></div><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/ef9a28f3-8919-33d5-dd07-5502add27830_hubae3a3a0d366681919d5913f54820b39_16047_715x169_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/ef9a28f3-8919-33d5-dd07-5502add27830.png width=715 height=169 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/ef9a28f3-8919-33d5-dd07-5502add27830_hubae3a3a0d366681919d5913f54820b39_16047_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/ef9a28f3-8919-33d5-dd07-5502add27830_hubae3a3a0d366681919d5913f54820b39_16047_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=423 data-flex-basis=1015px></picture><br>ちゃんと処理ができていますね。</p><h3 id=本番処理>本番処理</h3><h4 id=動作を調べる-3>動作を調べる</h4><p>先程と同様、調べていきます。まずHTMLを眺めてみます。<br>これはChromeの開発者ツールでは欲しい情報がすべては表示されないため、curlで落としてきます。</p><p>コマンドを再掲します。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;uid=ログインID&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;pass=パスワード&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;menuname=%8Fo%90%C8&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;module=Default&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;action=Login&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=p>|</span> nkf &gt; selectkamoku.html</span></span></code></pre></td></tr></table></div></div></div></div><p>実行すると、selectkamoku.htmlに登録時の番号選択の画面のHTMLが入っているはずです。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/799e1f06-4795-6883-9716-5478e932cc23_hu4b87741d73fe14f4c60d7e5742a35741_65161_1044x618_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/799e1f06-4795-6883-9716-5478e932cc23.png width=1044 height=618 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/799e1f06-4795-6883-9716-5478e932cc23_hu4b87741d73fe14f4c60d7e5742a35741_65161_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/799e1f06-4795-6883-9716-5478e932cc23_hu4b87741d73fe14f4c60d7e5742a35741_65161_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=168 data-flex-basis=405px></picture></p><p>HTMLが取得できたところで、次に出席登録時にはどんなデータが送られているかを見てみます。<br>先程までと同様、Chromeの開発者ツールを出して、出席登録を実際に行ったときにどんなForm dataが送られているかを見てみます。</p><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/cbfd4e7a-13a4-b824-5fbd-bfdfc5d99645_hue7fcab47cd37ba6f0d8097dca8ce2bfc_8840_576x150_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/cbfd4e7a-13a4-b824-5fbd-bfdfc5d99645.png width=576 height=150 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/cbfd4e7a-13a4-b824-5fbd-bfdfc5d99645_hue7fcab47cd37ba6f0d8097dca8ce2bfc_8840_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/cbfd4e7a-13a4-b824-5fbd-bfdfc5d99645_hue7fcab47cd37ba6f0d8097dca8ce2bfc_8840_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=384 data-flex-basis=921px></picture></p><p>このForm dataと、先程落としてきた番号選択の画面のHTMLを見比べてわかることとして、まずform内のhiddenとしての項目がいくつかあります。<br>まずは<code>PHPSESSID</code>ですが、これはセッションIDですね。これはcookie扱いなので、Form dataにはありませんでした。</p><p>他の項目はすべてForm dataとして送られるデータです。<br>まず<code>module</code>が<code>Sk</code>となっています。これはおそらく<strong>S</strong>elect <strong>k</strong>amokuの意味でしょう。</p><p><code>action</code>は<code>ProcedureAcc</code>となっています。手順アクセサリでしょうか。</p><p>プルダウンメニューの<code>SelKamoku</code>には、option内に講義選択内容があります。これは普通に履修登録をしていれば一つしか表示されないはずです。このvalue値で授業名を判定しているのでしょう。<br>普段授業名を選んでいるここの中身ですね。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/4ec44980-fdd5-b30e-40b8-1e1d3f46ea55_hu674b2f74373e4173937cd9fbccfbaea4_5847_268x130_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/4ec44980-fdd5-b30e-40b8-1e1d3f46ea55.png width=268 height=130 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/4ec44980-fdd5-b30e-40b8-1e1d3f46ea55_hu674b2f74373e4173937cd9fbccfbaea4_5847_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/4ec44980-fdd5-b30e-40b8-1e1d3f46ea55_hu674b2f74373e4173937cd9fbccfbaea4_5847_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=206 data-flex-basis=494px></picture></p><p>次に<code>InpNo</code>です。これはInputNumberでしょう。出席番号ですね。単純に1~9です。</p><p>最後に<code>submitButtonName</code>ですが、さっきログインのときもやったように、SJISエンコードされた文字を送ります。<code>出席登録</code>のSJISコードがURLエンコードされて<code>%8Fo%90%C8%93o%98%5E</code>となります。どうしてボタンのvalueで日本語を送信するんですか?</p><h4 id=curlでやってみる-1>curlでやってみる</h4><p>ではこれまで同様、curlでやってみましょう。やってることは簡単です。-dで投げるデータを変えるだけです。</p><p>なお、PHPSESSIDはForm dataではなくCookieとなるので、-dではなく&ndash;cookieを利用します。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cookie <span class=s2>&#34;PHPSESSID=8012d■■■■■■■■■■■■■■■■■■■■f154ee1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;module=Sk&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;action=ProcedureAcc&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;SelKamoku=2020,20■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■3041■■■■■■■■■■■■■■■■■■■■0,0&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;InpNo=1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;submitButtonName=%8Fo%90%C8%93o%98%5E&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> nkf</span></span></code></pre></td></tr></table></div></div></div></div><p>うまくいくと、コンソールに出席確認ができたことがわかるHTMLが流れてきます。</p><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/ff00ba2c-9919-407d-a496-b5dde546a258_hu19e0d4ac9165f52f5a3cf2c56d157041_77575_1366x554_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/ff00ba2c-9919-407d-a496-b5dde546a258.png width=1366 height=554 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/ff00ba2c-9919-407d-a496-b5dde546a258_hu19e0d4ac9165f52f5a3cf2c56d157041_77575_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/ff00ba2c-9919-407d-a496-b5dde546a258_hu19e0d4ac9165f52f5a3cf2c56d157041_77575_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=246 data-flex-basis=591px></picture></p><p>以上がCLIでやってみる出席登録です。<br>では、実際にこれを使って、2クリックシステムを作っていきましょう。</p><h3 id=実環境用ファイル作成>実環境用ファイル作成</h3><h4 id=シェルスクリプト-1>シェルスクリプト</h4><p>さて、ここまでの作業を組み合わせると、以下のようなシェルスクリプトを書けばいいことになります。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ログイン処理
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ログイン判定
</span></span><span class=line><span class=cl>  ログイン失敗処理
</span></span><span class=line><span class=cl>  ログイン成功処理
</span></span><span class=line><span class=cl>    時間外処理
</span></span><span class=line><span class=cl>    本番処理
</span></span><span class=line><span class=cl>      セッションIDの取得
</span></span><span class=line><span class=cl>      科目番号取得
</span></span><span class=line><span class=cl>      セッションIDと科目番号と、指示番号で登録
</span></span><span class=line><span class=cl>      結果表示</span></span></code></pre></td></tr></table></div></div></div></div><p>(「2. 実プログラムの配置」に貼ったソースを小分けにして解説していきます。各処理部分の調査部分の再掲みたいになってしまっていますが・・・)</p><h4 id=ログイン処理-1>ログイン処理</h4><p>まず、ログイン処理は以下のようになりますね。(最後のファイル保存場所が絶対パスで<code>/var/www/cgi-bin/htmlcache/</code>になっています)</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;uid=ログインID&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;pass=パスワード&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;menuname=%8Fo%90%C8&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;module=Default&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -d <span class=s2>&#34;action=Login&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=p>|</span> nkf &gt; /var/www/cgi-bin/htmlcache/selectkamoku.html</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=ログイン失敗処理-1>ログイン失敗処理</h4><p>次にログイン判定はgrepで「パスワード」を検索した結果を利用します。<br>失敗だったらレスポンスヘッダを吐いたあとに、selectkamoku.htmlの中身(エラー内容もある)をそのまんま吐くようにしています。</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=p>|</span> grep パスワード &gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>	<span class=c1># ログイン失敗</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>	cat /var/www/cgi-bin/htmlcache/selectkamoku.html
</span></span><span class=line><span class=cl>	exit</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=ログイン成功時間外処理>ログイン成功→時間外処理</h4><p>ログインに成功している場合は、時間外かどうかを見に行きます。</p><p>「現在時間に」という文字があったら、レスポンスヘッダと「時間外」という文字とともに、元のHTMLを吐いています。(この動作が、上記「3. 動作確認」のスクショ3枚目の時間外のときのものになります)</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=c1># ログイン成功のとき</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 時間外かどうかを判定</span>
</span></span><span class=line><span class=cl>	cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=p>|</span> grep 現在時間に &gt; /dev/null
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>		<span class=c1># 時間外のとき</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;&lt;b&gt;時間外&lt;/b&gt;&lt;br&gt;&lt;br&gt;&#34;</span>
</span></span><span class=line><span class=cl>		cat /var/www/cgi-bin/htmlcache/selectkamoku.html</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=本番処理-1>本番処理</h4><p>ログイン成功かつ時間外でもない場合は、いよいよ本番処理です。</p><h5 id=セッションid取得>セッションID取得</h5><p>まずはセッションIDを取得・変数代入します。</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl><span class=c1># セッションID</span>
</span></span><span class=line><span class=cl><span class=nv>sessid</span><span class=o>=</span><span class=sb>`</span>cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> grep <span class=s2>&#34;PHPSESSID&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> sed -e <span class=s1>&#39;s/&lt;form action=&#34;index.php&#34; method=&#34;post&#34;&gt;&lt;input type=&#34;hidden&#34; name=&#34;PHPSESSID&#34; value=&#34;//g&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> sed -e <span class=s1>&#39;s/&#34; \/&gt;//g&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##### 科目番号取得</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>次に科目の情報です
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 科目の番号</span>
</span></span><span class=line><span class=cl><span class=nv>selkamoku</span><span class=o>=</span><span class=sb>`</span>cat /var/www/cgi-bin/htmlcache/selectkamoku.html <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> grep <span class=s1>&#39;[0-9]\{4\},[0-9]\{8\}&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> sed -e <span class=s1>&#39;s/&lt;option value=&#34;//g&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> sed -e <span class=s1>&#39;s/&#34;&gt;.*//g&#39;</span><span class=sb>`</span></span></span></code></pre></td></tr></table></div></div></div></div><h5 id=出席登録結果表示>出席登録+結果表示</h5><p>最後に、出席登録を行います。出席登録では毎回番号が変わります。そのたびにシェルスクリプトを書き換えるわけにも行かないため、シェルスクリプト自体の引数で番号を受け取れるようにし、その番号を利用します。</p><p>すこし脱線しますが、シェルスクリプトでの引数は、第1引数から順番に<code>${1} ${2} ...</code>といったように呼び出せます。<br>シンプルな例だと、こんな感じになります。</p><div><div class=codeblock--name>test.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;第1引数: </span><span class=si>${</span><span class=nv>1</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;第2引数: </span><span class=si>${</span><span class=nv>2</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/eeeac154-e6ca-b8cd-3a3d-695584c9edb0_hu55de992ca294427f5760998fea5be325_10324_579x74_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/eeeac154-e6ca-b8cd-3a3d-695584c9edb0.png width=579 height=74 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/eeeac154-e6ca-b8cd-3a3d-695584c9edb0_hu55de992ca294427f5760998fea5be325_10324_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/eeeac154-e6ca-b8cd-3a3d-695584c9edb0_hu55de992ca294427f5760998fea5be325_10324_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=782 data-flex-basis=1877px></picture></p><p>今回のツールでは、出席番号以外はすべて自動で取得します。つまり、今回の場合はシェルスクリプトの第1引数に指示番号が与えられれば、それを元に全てを実行できることになります。<br>なので、スクリプト内ではInpNoの指定部分を<code>InpNo=${1}</code>とするだけで、引数を指示番号として利用できます。</p><p>(最後に結果を返せるように、登録結果をsuccess.htmlとして保存し、吐き出しています。)</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 出席登録</span>
</span></span><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cookie <span class=s2>&#34;PHPSESSID=</span><span class=si>${</span><span class=nv>sessid</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;module=Sk&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;action=ProcedureAcc&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d  <span class=s2>&#34;SelKamoku=</span><span class=si>${</span><span class=nv>selkamoku</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;InpNo=</span><span class=si>${</span><span class=nv>1</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d <span class=s2>&#34;submitButtonName=%8Fo%90%C8%93o%98%5E&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=p>|</span> nkf &gt; /var/www/cgi-bin/htmlcache/success.html
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 最終結果表示</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Content-Type: text/html; charset=UTF-8&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&lt;b&gt;登録処理&lt;/b&gt;&lt;br&gt;&lt;br&gt;&#34;</span>
</span></span><span class=line><span class=cl>cat /var/www/cgi-bin/htmlcache/success.html</span></span></code></pre></td></tr></table></div></div></div></div><p>最後に、if文を閉じれば、</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>	<span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></td></tr></table></div></div></div></div><p>シェルスクリプトは完成となります。</p><p>この段階でコンソールから直接引数ありで叩くと、実際に挙動を確かめることができます。(shコマンド無しでいきなり叩けてるのは権限が777のため)</p><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/a6a55983-dc5a-0b19-d5f0-eb10cfdb4daf_hu8359ffaa98ffc9e8b9f748db8651703e_73429_965x671_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/a6a55983-dc5a-0b19-d5f0-eb10cfdb4daf.png width=965 height=671 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/a6a55983-dc5a-0b19-d5f0-eb10cfdb4daf_hu8359ffaa98ffc9e8b9f748db8651703e_73429_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/a6a55983-dc5a-0b19-d5f0-eb10cfdb4daf_hu8359ffaa98ffc9e8b9f748db8651703e_73429_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=143 data-flex-basis=345px></picture></p><h4 id=htmlファイル>HTMLファイル</h4><p>上記のシェルスクリプトにより、<code>http://サーバーアドレス/cgi-bin/tcu_attend.sh</code>を呼び出せば出席登録ができるわけですが、このままでは引数が与えられず、意味がありません。<br>CGIでは、コマンドライン引数を与える方法として、URLの最後に<code>?</code>を付けると、その後がコマンドライン引数として使えるようになります。<br>今回の場合は引数が1つで、かつ単純に番号だけなので、以下のようなリンクにすれば、「1番で登録」用のリンクになります。</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://サーバーアドレス/cgi-bin/tcu_attend.sh?1</span></span></code></pre></td></tr></table></div></div></div></div><p>つまり、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span> <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>都市大出席<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl>	<span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?1&#34;</span><span class=p>&gt;</span>1<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?2&#34;</span><span class=p>&gt;</span>2<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?3&#34;</span><span class=p>&gt;</span>3<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?4&#34;</span><span class=p>&gt;</span>4<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?5&#34;</span><span class=p>&gt;</span>5<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?6&#34;</span><span class=p>&gt;</span>6<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?7&#34;</span><span class=p>&gt;</span>7<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?8&#34;</span><span class=p>&gt;</span>8<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://example.com/cgi-bin/tcu_attend.sh?9&#34;</span><span class=p>&gt;</span>9<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;</span><span class=nt>br</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>のようなシンプルなHTMLで、<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/ae50ec99-05bc-1681-dba6-65fab7c20a24_hucdaff8fea7bfc4813e607b15ac943131_10554_513x307_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/ae50ec99-05bc-1681-dba6-65fab7c20a24.png width=513 height=307 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/ae50ec99-05bc-1681-dba6-65fab7c20a24_hucdaff8fea7bfc4813e607b15ac943131_10554_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/ae50ec99-05bc-1681-dba6-65fab7c20a24_hucdaff8fea7bfc4813e607b15ac943131_10554_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=167 data-flex-basis=401px></picture></p><p>最低限の実装ができます。</p><p>ただ、これだとあまりにも見た目が貧相なのと、スマホフレンドリーでもなく、使い勝手も地獄なので、ボタン化して使いやすくします。</p><p>実HTMLはすでに貼ってあるので、抜粋すると、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;1&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width:80px; font-size:70px; margin-bottom:4px;&#34;</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;location.href=&#39;http://example.com/cgi-bin/tcu_attend.sh?1&#39;&#34;</span><span class=p>&gt;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>のようにinputでボタンを書けば、<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/e945690a-30c8-af93-4a5f-b42b6dd864d0_hu83c921140e53af84e98c1129cc6bef2f_7274_447x161_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/e945690a-30c8-af93-4a5f-b42b6dd864d0.png width=447 height=161 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/e945690a-30c8-af93-4a5f-b42b6dd864d0_hu83c921140e53af84e98c1129cc6bef2f_7274_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/e945690a-30c8-af93-4a5f-b42b6dd864d0_hu83c921140e53af84e98c1129cc6bef2f_7274_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=277 data-flex-basis=666px></picture></p><p>こんな感じでボタン化することができます。<br>これを9個にして、間隔とかを整えたものが「3. 動作確認」に貼ったような画面になります。<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/4cda660c-d606-25d7-0d53-d30081796109_hu8c0f56eb75ed151276c7c3074d8bb3d6_18733_422x336_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/4cda660c-d606-25d7-0d53-d30081796109.png width=422 height=336 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/4cda660c-d606-25d7-0d53-d30081796109_hu8c0f56eb75ed151276c7c3074d8bb3d6_18733_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/4cda660c-d606-25d7-0d53-d30081796109_hu8c0f56eb75ed151276c7c3074d8bb3d6_18733_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=125 data-flex-basis=301px></picture></p><p>以上でシェルスクリプトとHTMLの完成です!</p><h2 id=おまけ1-idとパスワードをシェルスクリプトから分離して保存する>おまけ1: IDとパスワードをシェルスクリプトから分離して保存する</h2><p>一応、CGIとして動作しているので、shファイルを直接読まれることは無く、パスワード漏洩もしにくいとは思いますが、それでも/var/www/cgi-binというApache2管理下の内にあるファイルなので、万が一のことがあるかもしれません。</p><p>そこで、IDとパスワードは別ファイルに保管し、実行されるたびにそこから情報を拾ってきて使うようにしてみます。</p><p>(「2. 実プログラムの配置」で記載したソースにはこれは書いていません。それも含めて書くのは面倒だったので&mldr;。 ただやるとしても簡単に改変できるので、もし心配だったらやってみてください。)</p><p>まずは、ファイルを置くための場所を作ります。とりあえず<code>/var/www/cgi-bin</code>じゃなければいいので、適当に<code>/var/www/tcuattenddata/</code>とかを作ります。(いろいろとアレですが、ここらへんはお好きなように・・・)</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir /var/www/tcuattenddata/</span></span></code></pre></td></tr></table></div></div></div></div><p>そしてここに<code>id_pass.txt</code>を作り、<strong>1行目にID</strong>、<strong>2行目にパスワード</strong>を記述した本当に単純なファイルを作成します。(複数ユーザーがいないからできるような運用方法ですねホントに)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/885e53f7-368b-9d2b-2fc5-22942c0c7666_hu58b912ad51cfde208ab785cb1ec7b87f_6961_612x70_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/885e53f7-368b-9d2b-2fc5-22942c0c7666.png width=612 height=70 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/885e53f7-368b-9d2b-2fc5-22942c0c7666_hu58b912ad51cfde208ab785cb1ec7b87f_6961_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/885e53f7-368b-9d2b-2fc5-22942c0c7666_hu58b912ad51cfde208ab785cb1ec7b87f_6961_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=874 data-flex-basis=2098px></picture></p><p>次に、これらをシェルスクリプトで変数に代入するようにします。</p><p>引っ張り出し方は、</p><div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ID</span>
</span></span><span class=line><span class=cl>sed -n 1p /var/www/tcuattenddata/id_pass.txt
</span></span><span class=line><span class=cl><span class=c1># パスワード</span>
</span></span><span class=line><span class=cl>sed -n 2p /var/www/tcuattenddata/id_pass.txt</span></span></code></pre></td></tr></table></div></div></div></div><p>のように、sedで行数指定で取り出して行います。</p><p><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/7c40b42b-c4fc-52e7-0153-2ac587cfe435_hu4204087823366f079b6d39efcad4f250_12248_649x93_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/7c40b42b-c4fc-52e7-0153-2ac587cfe435.png width=649 height=93 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/7c40b42b-c4fc-52e7-0153-2ac587cfe435_hu4204087823366f079b6d39efcad4f250_12248_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/7c40b42b-c4fc-52e7-0153-2ac587cfe435_hu4204087823366f079b6d39efcad4f250_12248_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=697 data-flex-basis=1674px></picture></p><p>これを変数に入れられればいいので、シェルスクリプトの最上位(#!/bin/bashの次)に以下のような行を追記します</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ID</span>
</span></span><span class=line><span class=cl><span class=nv>USERID</span><span class=o>=</span><span class=sb>`</span>sed -n 1p /var/www/tcuattenddata/id_pass.txt<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=c1># パスワード</span>
</span></span><span class=line><span class=cl><span class=nv>PASSWORD</span><span class=o>=</span><span class=sb>`</span>sed -n 2p /var/www/tcuattenddata/id_pass.txt<span class=sb>`</span></span></span></code></pre></td></tr></table></div></div></div></div><p>これで<code>USERID</code>にIDが、<code>PASSWORD</code>にパスワードが入ります。</p><p>次に、これをcurlの引数内で呼べるようにします。<br>本番処理のところでも書きましたが、Form Dataに与える部分はダブルクオーテーションで囲まれているので、単純に<code>${USERID}</code>や<code>${PASSWORD}</code>とするだけで呼び出せます。(シングルクオートだとエスケープが必要になる) (一応<code>{ }</code>がなくても良い)</p><p>(ダブルクオーテーションがあるので実験も含めてダブルクオーテーション込みで出しています)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/7721bb56-c955-3082-6853-7555dcaafb0e_hu3e525e6c305d987efc5d4a4f83e64575_9560_418x99_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/7721bb56-c955-3082-6853-7555dcaafb0e.png width=418 height=99 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/7721bb56-c955-3082-6853-7555dcaafb0e_hu3e525e6c305d987efc5d4a4f83e64575_9560_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/7721bb56-c955-3082-6853-7555dcaafb0e_hu3e525e6c305d987efc5d4a4f83e64575_9560_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=422 data-flex-basis=1013px></picture></p><p>幸いにも、都市大のパスワードレギュレーションはダブルクオートとシングルクオートを弾いているので、このあたりのエスケープは無視することができます。</p><p>最後に、シェルスクリプトのユーザー名とパスワードの部分を<code>${USERID}</code>と<code>${PASSWORD}</code>に変更してあげれば、完成となります。</p><div><div class=codeblock--name>/var/www/cgi-bin/tcu_attend.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST https://call.off.tcu.ac.jp/index.php -d <span class=s2>&#34;uid=</span><span class=si>${</span><span class=nv>USERID</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;pass=</span><span class=si>${</span><span class=nv>PASSWORD</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;menuname=%8Fo%90%C8&#34;</span> -d <span class=s2>&#34;module=Default&#34;</span> -d <span class=s2>&#34;action=Login&#34;</span> <span class=p>|</span> nkf &gt; /var/www/cgi-bin/htmlcache/selectkamoku.html</span></span></code></pre></td></tr></table></div></div></div></div><p>(もちろん動作確認はしてあげてくださいね!)</p><h2 id=おまけ2公開鯖向け-一応robotstxtを書く>おまけ2(公開鯖向け): 一応robots.txtを書く</h2><p>なんかの拍子にクローラに見つかっても困るので、robots.txtを書いておきます。(この手の対策ってお行儀の良いクローラにしか意味ないですけどね)</p><div><div class=codeblock--name>robots.txt</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>User-Agent: *
</span></span><span class=line><span class=cl>Disallow: /tcu_attend.html</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=おまけ3-discordのbotにしてみる>おまけ3: DiscordのBotにしてみる</h2><p>DiscordのBotにして、Discordのチャットから出席登録できたら便利かもしれません。<br>こんな感じに。(brとか残ってるのは許してくださいガバガバ処理なだけです)<br><picture><source srcset=/posts/2020/20201209-2-click-tcu-attend-system/img/c4cd04ef-b84a-9c18-9af9-ede423da5258_hu9564e3601be98a727da355f60f1d7794_22030_583x216_resize_q75_h2_box_3.webp type=image/webp><img src=/posts/2020/20201209-2-click-tcu-attend-system/img/c4cd04ef-b84a-9c18-9af9-ede423da5258.png width=583 height=216 srcset="/posts/2020/20201209-2-click-tcu-attend-system/img/c4cd04ef-b84a-9c18-9af9-ede423da5258_hu9564e3601be98a727da355f60f1d7794_22030_480x0_resize_box_3.png 480w, /posts/2020/20201209-2-click-tcu-attend-system/img/c4cd04ef-b84a-9c18-9af9-ede423da5258_hu9564e3601be98a727da355f60f1d7794_22030_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=269 data-flex-basis=647px></picture></p><p>Discordは、シェルスクリプトだけでは(おそらく)文字を受け取るBotは流石に無理があります。Webhookで一方通行ならできますが。</p><p>ということで、文字を受け取るBotはNodejsを使うことになります。でも、ここまで作ってきたものはシェルスクリプトです。JavaScriptじゃありません。<strong>じゃあシェルスクリプトをNodejsから叩いてしまいましょう!</strong> (アドカレ主催に怒られそう)</p><p>ということでソースです。と言いたいこところですが、その前に説明です。</p><p>せっかくここまでWebからできる出席登録を作ったので、Botで呼ばれたらそこにアクセスすればいいわけです。それこそJSで出来ます。</p><p>できるんですが・・・ここまでシェルスクリプトでやってきてるので、ここもやっぱりシェルスクリプトとcurlでがんばります。</p><p>つまり、動作概要としては、<br>Discord →(文字列)→ Nodejs(文字列処理) → bash(ここまで作ったやつをcurlで叩くシェルスクリプト実行) → Web鯖(出席登録のシェルスクリプト) → bash(帰ってきた結果を若干加工してstdout) → Nodejs(Discordにsend) → Discord</p><p>というすごい遠回りをします。完全にNodejsはDiscordとbashを繋ぐためのやつになります。</p><p>まずは、ここまで作った「CGIとしてのシェルスクリプト」を叩くシェルスクリプトです。</p><div><div class=codeblock--name>attendbot.sh</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -sS https://hoge.hoge/cgi-bin/attend.sh?<span class=nv>$1</span> <span class=p>|</span> nkf &gt;  /tmp/attendtmp.html
</span></span><span class=line><span class=cl>cat /tmp/attendtmp.html <span class=p>|</span> grep 現在時間に &gt; /dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;時間外です&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    cat /tmp/attendtmp.html <span class=p>|</span> grep 受け付けました &gt; /dev/null
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> <span class=o>=</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        cat /tmp/attendtmp.html <span class=p>|</span> grep 授業科目
</span></span><span class=line><span class=cl>        cat /tmp/attendtmp.html <span class=p>|</span> grep 指示番号
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;成功しました&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;error!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></td></tr></table></div></div></div></div><p>HTML側でボタンクリックしたときのリンクを直接叩いています。シェルスクリプト実行時の引数に番号だけ入れればいいので、あとでJS側から引数ありで叩いてあげればいいわけですね。</p><p><del>なんかJSって言ってるとケーを思い出しますね</del></p><p>このシェルスクリプトが呼ばれると、さっきつくったCGIをcurlで叩いて、落ちてきたやつをgrepなりで処理してechoします。ここは別になにかForm dataとかを送るわけでもないので、-sSでログを出さないようにするだけで、後はただ叩くだけです。後一応nkfを通しています。</p><p>落ちてきたHTMLの中の授業科目/指示番号が書いてある行だけgrepで取り出しています。そのあとにsedでタグを取り除いてあげれば、先程の画像のようなことは起きませんね。</p><p>次にNodejsで動かすJavaScriptのソースです。discord.jsはインストールしてくださいね。</p><div><div class=codeblock--name>app.js</div><div class=codeblock--content><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>//ログイン処理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>Discord</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;discord.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>client</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Discord</span><span class=p>.</span><span class=nx>Client</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=s1>&#39;BotToken&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>client</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;ready&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;ready...&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>client</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=nx>message</span> <span class=p>=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>author</span><span class=p>.</span><span class=nx>bot</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//出席登録
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=sr>/!attend/</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>str</span> <span class=o>=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>content</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>str</span><span class=o>=</span><span class=nx>str</span><span class=p>.</span><span class=nx>substr</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>execstr</span><span class=o>=</span><span class=s1>&#39;bash /path/to/attendbot.sh &#39;</span><span class=o>+</span> <span class=nx>str</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>execSync</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;child_process&#39;</span><span class=p>).</span><span class=nx>execSync</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span>  <span class=nx>execSync</span><span class=p>(</span><span class=nx>execstr</span><span class=p>).</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>result</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span><span class=p>.</span><span class=nx>channel</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;エラーが発生しました&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span><span class=p>.</span><span class=nx>channel</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>result</span><span class=p>);</span>    
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>client</span><span class=p>.</span><span class=nx>login</span><span class=p>(</span><span class=nx>token</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div></div></div><p>受け取って、!attendから始まる場合だけ処理して、数字を取り出してシェルスクリプトにぶん投げる感じです。</p><p>参考:</p><ul><li><a class=link href=https://qiita.com/cryptocoin_harumaki/items/5d8c503e02093eca1f9b target=_blank rel=noopener>Discord.jsで簡単にbotを作成する【基礎編】</a></li><li><a class=link href=https://www.wakuwakubank.com/posts/728-nodejs-child-process/ target=_blank rel=noopener>シェルコマンドを実行する方法(child_process)</a></li></ul><p>あとはNodejsで回してあげれば、Discordから出席登録ができるようになります。</p><h2 id=〆>〆</h2><p>いかがだったでしょうか。<br>こんな感じで、シェルスクリプトだけでもいろいろとWebツールは作れます。そしてそれをNodejsから叩く方法を確立させれば、シェルスクリプトだけで何でもできます(?)</p><p>JavaScriptもいいですけど、ShellScriptもいいんですからね・・・?</p><p>これを読んだ都市大生の皆様は、1から作らなくてもいいので、今回のプログラムをぜひ使ってみて下さい!! WSLでもいいですしmなんなら家に一個くらいラズパイ転がってますよね!(???)</p><p>ということで、明日は<a class=link href=https://twitter.com/vividrabbit_net target=_blank rel=noopener>うめ</a>さんの「どうすりゃいいの～♪」です。どうなるんですかね? (あと<a class=link href=https://adventar.org/calendars/5925 target=_blank rel=noopener>このアドカレはなんですか?</a>)</p><h2 id=宣伝>宣伝</h2><p><a class=link href=https://blog.mikuta0407.net/posts/2020/20201202-music-on-2dd-fd/ target=_blank rel=noopener>フロピネタもよろしく!</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>関連するコンテンツ</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/2023/20230807-making-of-x-bot-for-kuchiwohiraku/><div class=article-image><img src=/posts/2023/20230807-making-of-x-bot-for-kuchiwohiraku/img/_hued2eb23146221757a2e86c10559b40be_153251_9451e750af6e0a0d5c87d573b8635829.png width=250 height=150 loading=lazy alt="Featured image of post リスナーが勝手にPodcast番組の更新通知Botを作って遊んだ話" data-hash="md5-lk0yEBClDccxxfFbS+sZXA=="></div><div class=article-details><h2 class=article-title>リスナーが勝手にPodcast番組の更新通知Botを作って遊んだ話</h2></div></a></article><article class=has-image><a href=/posts/2022/20221216-misskey-cli/><div class=article-image><img src=/posts/2022/20221216-misskey-cli/img/misskey-cli-scr.7dad8a8f888e419ba97a42744e3827f0_hu951e91d74c3322dab0f9ffb021ed0c8b_6422243_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)" data-hash="md5-fa2Kj4iOQZupekJ0Tjgn8A=="></div><div class=article-details><h2 class=article-title>GoでMisskeyのCLIクライアントを作った話 (Misskey Advent Calender 2022)</h2></div></a></article><article><a href=/posts/2020/20200213-wakeonlan-from-browser/><div class=article-details><h2 class=article-title>ブラウザ経由でシェルスクリプト叩いてWake on LANする</h2></div></a></article><article><a href=/posts/2019/20191204-c-dev-env-for-msdos/><div class=article-details><h2 class=article-title>C言語開発環境を構築しよう! ～超遠回り編～</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2024 mikuta0407</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> で構築されています。<br>テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>